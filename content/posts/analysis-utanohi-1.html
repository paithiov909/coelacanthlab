---
title: 短歌の構文マイニング（１）
author: paithiov909
date: '2020-07-21'
lastmod: "2020-08-29"
slug: analysis-utanohi-1
categories: []
tags:
  - NLP
  - Preprocessing
description: '{udpipe}による解析'
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<div id="データの読み込み" class="section level2">
<h2>データの読み込み</h2>
<p><a href="https://note.com/shinabitanori/n/nb55d8c7d041d">この記事</a>を書いたときに収集した短歌を解析する。</p>
<blockquote>
<p>うたの日のオープン1001日目から1500日目までの500日間に投稿された短歌（74,857首）をスクレイピングして分析しました。
それぞれの短歌について、詠んだ人の筆名・投稿された日・投稿された部屋・もらったハートの数（「選」をした際につく+1を除く）に加えて、今回はもらった音符の数も収集しています。
該当期間中は全部で2,383部屋あったっぽいです（「自由詠」などの重複する題を含みます）。</p>
</blockquote>
<pre class="r"><code>doc &lt;- CSV %&gt;%
  readr::read_csv() %&gt;%
  dplyr::rename(doc_id = X1) %&gt;%
  dplyr::mutate(names = stringr::str_remove_all(names, &quot;[&lt;U\\+A&gt;]&quot;)) %&gt;%
  dplyr::mutate(text = zipangu::str_conv_normalize(poems)) %&gt;%
  dplyr::mutate(names = as.factor(names)) %&gt;%
  dplyr::mutate(keys1 = as.factor(keys1)) %&gt;%
  dplyr::mutate(keys2 = as.factor(keys2))
#&gt; Parsed with column specification:
#&gt; cols(
#&gt;   X1 = col_double(),
#&gt;   poems = col_character(),
#&gt;   names = col_character(),
#&gt;   loves = col_double(),
#&gt;   likes = col_double(),
#&gt;   keys1 = col_double(),
#&gt;   keys2 = col_character()
#&gt; )</code></pre>
</div>
<div id="解析にかかる時間の見積もり" class="section level2">
<h2>解析にかかる時間の見積もり</h2>
<p>25分くらいかかりそう</p>
<pre class="r"><code>bench &lt;- microbenchmark::microbenchmark(
  annotation = udpipe::udpipe(head(doc, 100), object = &quot;japanese&quot;),
  times = 5L
)
ggplot2::autoplot(bench)
#&gt; Coordinate system already present. Adding new coordinate system, which will replace the existing one.</code></pre>
<p><img src="/posts/analysis-utanohi-1_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>nrow(doc) / 100 * median(bench$time) / 60.00e+09
#&gt; [1] 21.83562</code></pre>
</div>
<div id="解析" class="section level2">
<h2>解析</h2>
<pre class="r"><code>if (!file.exists(&quot;cache/annotation.feather&quot;)) {
  annotation &lt;- udpipe::udpipe(head(doc, 10), object = &quot;japanese&quot;)
  annotation &lt;- doc %&gt;%
    dplyr::mutate(doc_id = as.character(doc_id)) %&gt;%
    dplyr::right_join(annotation, by = &quot;doc_id&quot;) %&gt;%
    dplyr::mutate(upos = as.factor(upos)) %&gt;%
    dplyr::mutate(xpos = as.factor(xpos)) %&gt;%
    dplyr::mutate(dep_rel = as.factor(dep_rel)) %&gt;%
    dplyr::select(-feats, -deps, -misc) %&gt;%
    feather::write_feather(&quot;cache/annotation.feather&quot;)
}</code></pre>
<pre class="r"><code>annotation &lt;- feather::read_feather(&quot;cache/annotation.feather&quot;)
words &lt;- udpipe::keywords_collocation(
  dplyr::filter(annotation, upos %in% c(&quot;SCONJ&quot;, &quot;ADP&quot;, &quot;VERB&quot;)),
  term = &quot;lemma&quot;,
  group = c(&quot;doc_id&quot;, &quot;sentence_id&quot;),
  ngram_max = 6L
)
words %&gt;%
  dplyr::select(1:7) %&gt;%
  dplyr::arrange(desc(freq)) %&gt;%
  head(200) %&gt;%
  DT::datatable()</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200"],["の に","の の","の を","て の","の は","の が","は の","の で","に は","する て","に なる","に を","て を","て は","の と","て も","て に","に の","と の","は に","を する","が の","は を","て て","て と","て が","を に","が に","に も","も の","に が","が を","は と","と を","に する","の も","と 言う","と する","の の の","と は","で を","の の に","で も","を 見る","は が","で の","の の を","は で","が ある","も も","見る て","が と","と に","で は","と が","も に","を の","て の に","の は の","から の","を と","と 思う","に と","の から","と する て","て で","て から","て の の","を する て","の の は","の に は","言う て","て の を","も は","の の が","て の は","に に","の に を","も を","の に の","で に","なる て","は も","は は","する の","と なる","ば の","も が","生きる て","も と","を で","と と","ある の","を 見る て","は の に","の へ","へ と","が いる","に する て","を 知る","に いる","が する","で が","が で","は の の","は の を","なる の","の の で","に なる て","の に が","に ある","が は","の は に","を つく","を は","で と","に は の","知る て","の が の","いる て","だけ の","て の が","から を","こと を","へ の","の を に","する て の","が 来る","と で","を 待つ","に で","も ある","に の を","の が に","に 行く","から は","は て","て は の","つく て","と 呼ぶ","の に なる","出る て","の だけ","泣く て","だけ が","を が","来る て","言う の","から に","は から","の で を","待つ て","て ば","の は を","と の を","に なる の","笑う て","の を する","と 言う て","から が","の に も","の ある","食べる て","が が","いる の","の を 見る","を 食べる","だけ で","より も","と も","を に する","思う て","が の に","が て","の の と","ある て","の が を","の と の","も で","が に なる","こと が","ば に","を を","似る て","は ある","は に なる","て も の","に 来る","と の に","に は が","こと は","が の を","は の が","の て","て に なる","う て","に の が","は する","に 似る","の は と"],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,3,2,2,2,2,3,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,2,2,3,2,2,3,3,3,3,2,3,2,3,3,2,3,2,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,3,2,2,2,2,2,3,3,2,3,3,3,2,2,3,2,2,2,3,2,3,2,2,3,2,2,2,3,3,2,2,2,2,2,3,3,2,2,2,3,2,2,3,2,2,2,2,2,2,2,2,2,3,2,2,3,3,3,2,3,3,2,3,2,2,2,2,3,2,2,2,2,3,2,3,2,3,2,3,3,2,3,2,2,2,2,2,3,3,2,3,3,2,3,3,2,3,2,3,2,2,3],["の","の","の","て","の","の","は","の","に","する","に","に","て","て","の","て","て","に","と","は","を","が","は","て","て","て","を","が","に","も","に","が","は","と","に","の","と","と","の の","と","で","の の","で","を","は","で","の の","は","が","も","見る","が","と","で","と","も","を","て の","の は","から","を","と","に","の","と する","て","て","て の","を する","の の","の に","言う","て の","も","の の","て の","に","の に","も","の に","で","なる","は","は","する","と","ば","も","生きる","も","を","と","ある","を 見る","は の","の","へ","が","に する","を","に","が","で","が","は の","は の","なる","の の","に なる","の に","に","が","の は","を","を","で","に は","知る","の が","いる","だけ","て の","から","こと","へ","の を","する て","が","と","を","に","も","に の","の が","に","から","は","て は","つく","と","の に","出る","の","泣く","だけ","を","来る","言う","から","は","の で","待つ","て","の は","と の","に なる","笑う","の を","と 言う","から","の に","の","食べる","が","いる","の を","を","だけ","より","と","を に","思う","が の","が","の の","ある","の が","の と","も","が に","こと","ば","を","似る","は","は に","て も","に","と の","に は","こと","が の","は の","の","て に","う","に の","は","に","の は"],["に","の","を","の","は","が","の","で","は","て","なる","を","を","は","と","も","に","の","の","に","する","の","を","て","と","が","に","に","も","の","が","を","と","を","する","も","言う","する","の","は","を","に","も","見る","が","の","を","で","ある","も","て","と","に","は","が","に","の","に","の","の","と","思う","と","から","て","で","から","の","て","は","は","て","を","は","が","は","に","を","を","の","に","て","も","は","の","なる","の","が","て","と","で","と","の","て","に","へ","と","いる","て","知る","いる","する","が","で","の","を","の","で","て","が","ある","は","に","つく","は","と","の","て","の","て","の","が","を","を","の","に","の","来る","で","待つ","で","ある","を","に","行く","は","て","の","て","呼ぶ","なる","て","だけ","て","が","が","て","の","に","から","を","て","ば","を","を","の","て","する","て","が","も","ある","て","が","の","見る","食べる","で","も","も","する","て","に","て","と","て","を","の","で","なる","が","に","を","て","ある","なる","の","来る","に","が","は","を","が","て","なる","て","が","する","似る","と"],[9977,9742,8786,6657,6171,5481,4142,3435,3202,2872,2737,2729,2624,2585,2528,2490,2471,2451,2366,2119,1978,1963,1948,1871,1815,1738,1711,1583,1516,1441,1423,1417,1409,1403,1396,1396,1365,1294,1294,1277,1273,1269,1250,1227,1222,1142,1127,1106,1082,1045,1006,981,961,939,921,901,870,866,854,817,817,812,806,802,799,798,760,756,744,732,732,727,719,716,714,704,701,699,690,690,678,661,660,649,639,609,600,589,581,573,568,560,554,553,548,547,544,544,544,542,536,533,519,510,498,488,481,480,477,477,474,470,455,447,443,442,439,435,435,427,427,419,418,417,416,416,413,412,410,406,403,400,397,391,390,390,386,383,382,381,378,374,367,361,360,350,349,348,347,345,344,343,338,336,334,334,331,328,327,327,327,326,325,324,323,322,322,321,320,319,318,318,311,311,308,303,299,296,296,287,285,285,285,281,281,279,279,278,278,277,277,275,273,271,270,269,269,269,268,268],[73290,73290,73290,46908,73290,73290,29311,73290,40115,7093,40115,40115,46908,46908,73290,46908,46908,40115,23168,29311,37509,24757,29311,46908,46908,46908,37509,24757,40115,14954,40115,24757,29311,23168,40115,73290,23168,23168,9742,23168,14685,9742,14685,37509,29311,14685,9742,29311,24757,14954,2523,24757,23168,14685,23168,14954,37509,6657,6171,6216,37509,23168,40115,73290,1294,46908,46908,6657,1978,9742,9977,2996,6657,14954,9742,6657,40115,9977,14954,9977,14685,3909,29311,29311,7093,23168,3404,14954,1082,14954,37509,23168,3415,1227,4142,73290,2658,24757,1396,37509,40115,24757,14685,24757,4142,4142,3909,9742,2737,9977,40115,24757,6171,37509,37509,14685,3202,1799,5481,2595,2509,6657,6216,2789,2658,8786,2872,24757,23168,37509,40115,14954,2451,5481,40115,6216,29311,2585,1578,23168,9977,953,73290,874,2509,37509,1552,2996,6216,29311,3435,804,46908,6171,2366,2737,832,8786,1365,6216,9977,73290,1240,24757,2595,8786,37509,2509,1175,23168,1711,1307,1963,24757,9742,3415,5481,2528,14954,1583,2789,3404,37509,514,29311,2119,2490,40115,2366,3202,2789,1963,4142,73290,2471,437,2451,29311,40115,6171],[31814,55442,30321,55442,24289,19920,55442,11504,24289,46434,3856,30321,30321,24289,18436,12962,31814,55442,55442,31814,6739,55442,30321,46434,18436,19920,31814,31814,12962,55442,19920,30321,18436,30321,6739,12962,2876,6739,45059,24289,30321,25185,12962,2401,19920,55442,24026,11504,3201,12962,46434,18436,31814,24289,19920,31814,55442,25185,45059,55442,18436,1282,18436,4766,41743,11504,4766,45059,41743,19676,19676,46434,24026,24289,16022,19676,31814,24026,30321,45059,31814,46434,12962,24289,55442,3856,55442,19920,46434,18436,11504,18436,55442,41743,25185,2258,18436,2385,41743,1680,2385,6739,19920,11504,45059,24026,55442,8996,41743,16022,3201,24289,25185,1482,24289,18436,45059,46434,45059,46434,55442,16022,30321,30321,55442,25185,45059,1429,11504,753,11504,3201,24026,25185,949,24289,46434,45059,46434,774,3304,46434,2043,46434,19920,19920,46434,55442,31814,4766,24026,46434,3303,24026,24026,45059,46434,5683,41743,19920,10612,3201,46434,19920,55442,2084,1115,11504,12962,12962,5683,46434,25185,46434,15143,46434,24026,45059,11504,3304,19920,31814,30321,46434,3201,3304,45059,1429,25185,16022,24289,24026,16022,46434,3304,46434,16022,6739,486,15143]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>keyword<\/th>\n      <th>ngram<\/th>\n      <th>left<\/th>\n      <th>right<\/th>\n      <th>freq<\/th>\n      <th>freq_left<\/th>\n      <th>freq_right<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="セッション情報" class="section level2">
<h2>セッション情報</h2>
<pre class="r"><code>sessioninfo::session_info()
#&gt; - Session info ---------------------------------------------------------------
#&gt;  setting  value                       
#&gt;  version  R version 4.0.2 (2020-06-22)
#&gt;  os       Windows 10 x64              
#&gt;  system   x86_64, mingw32             
#&gt;  ui       RTerm                       
#&gt;  language (EN)                        
#&gt;  collate  Japanese_Japan.932          
#&gt;  ctype    Japanese_Japan.932          
#&gt;  tz       Asia/Tokyo                  
#&gt;  date     2020-08-29                  
#&gt; 
#&gt; - Packages -------------------------------------------------------------------
#&gt;  package        * version date       lib source        
#&gt;  assertthat       0.2.1   2019-03-21 [1] CRAN (R 4.0.2)
#&gt;  backports        1.1.8   2020-06-17 [1] CRAN (R 4.0.2)
#&gt;  blob             1.2.1   2020-01-20 [1] CRAN (R 4.0.2)
#&gt;  blogdown         0.20    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  bookdown         0.20    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  broom            0.7.0   2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  cellranger       1.1.0   2016-07-27 [1] CRAN (R 4.0.2)
#&gt;  cli              2.0.2   2020-02-28 [1] CRAN (R 4.0.2)
#&gt;  colorspace       1.4-1   2019-03-18 [1] CRAN (R 4.0.2)
#&gt;  crayon           1.3.4   2017-09-16 [1] CRAN (R 4.0.2)
#&gt;  crosstalk        1.1.0.1 2020-03-13 [1] CRAN (R 4.0.2)
#&gt;  curl             4.3     2019-12-02 [1] CRAN (R 4.0.2)
#&gt;  data.table       1.13.0  2020-07-24 [1] CRAN (R 4.0.2)
#&gt;  DBI              1.1.0   2019-12-15 [1] CRAN (R 4.0.2)
#&gt;  dbplyr           1.4.4   2020-05-27 [1] CRAN (R 4.0.2)
#&gt;  digest           0.6.25  2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  dplyr          * 1.0.1   2020-07-31 [1] CRAN (R 4.0.2)
#&gt;  DT               0.15    2020-08-05 [1] CRAN (R 4.0.2)
#&gt;  ellipsis         0.3.1   2020-05-15 [1] CRAN (R 4.0.2)
#&gt;  evaluate         0.14    2019-05-28 [1] CRAN (R 4.0.2)
#&gt;  fansi            0.4.1   2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  farver           2.0.3   2020-01-16 [1] CRAN (R 4.0.2)
#&gt;  feather          0.3.5   2019-09-15 [1] CRAN (R 4.0.2)
#&gt;  forcats        * 0.5.0   2020-03-01 [1] CRAN (R 4.0.2)
#&gt;  fs               1.5.0   2020-07-31 [1] CRAN (R 4.0.2)
#&gt;  generics         0.0.2   2018-11-29 [1] CRAN (R 4.0.2)
#&gt;  ggplot2        * 3.3.2   2020-06-19 [1] CRAN (R 4.0.2)
#&gt;  glue             1.4.1   2020-05-13 [1] CRAN (R 4.0.2)
#&gt;  gtable           0.3.0   2019-03-25 [1] CRAN (R 4.0.2)
#&gt;  haven            2.3.1   2020-06-01 [1] CRAN (R 4.0.2)
#&gt;  hms              0.5.3   2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  htmltools        0.5.0   2020-06-16 [1] CRAN (R 4.0.2)
#&gt;  htmlwidgets      1.5.1   2019-10-08 [1] CRAN (R 4.0.2)
#&gt;  httr             1.4.2   2020-07-20 [1] CRAN (R 4.0.2)
#&gt;  jsonlite         1.7.0   2020-06-25 [1] CRAN (R 4.0.2)
#&gt;  knitr            1.29    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  lattice          0.20-41 2020-04-02 [2] CRAN (R 4.0.2)
#&gt;  lifecycle        0.2.0   2020-03-06 [1] CRAN (R 4.0.2)
#&gt;  lubridate        1.7.9   2020-06-08 [1] CRAN (R 4.0.2)
#&gt;  magrittr         1.5     2014-11-22 [1] CRAN (R 4.0.2)
#&gt;  Matrix           1.2-18  2019-11-27 [2] CRAN (R 4.0.2)
#&gt;  microbenchmark   1.4-7   2019-09-24 [1] CRAN (R 4.0.2)
#&gt;  modelr           0.1.8   2020-05-19 [1] CRAN (R 4.0.2)
#&gt;  munsell          0.5.0   2018-06-12 [1] CRAN (R 4.0.2)
#&gt;  pillar           1.4.6   2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  pkgconfig        2.0.3   2019-09-22 [1] CRAN (R 4.0.2)
#&gt;  purrr          * 0.3.4   2020-04-17 [1] CRAN (R 4.0.2)
#&gt;  R.cache          0.14.0  2019-12-06 [1] CRAN (R 4.0.2)
#&gt;  R.methodsS3      1.8.0   2020-02-14 [1] CRAN (R 4.0.0)
#&gt;  R.oo             1.23.0  2019-11-03 [1] CRAN (R 4.0.0)
#&gt;  R.utils          2.9.2   2019-12-08 [1] CRAN (R 4.0.2)
#&gt;  R6               2.4.1   2019-11-12 [1] CRAN (R 4.0.2)
#&gt;  Rcpp             1.0.5   2020-07-06 [1] CRAN (R 4.0.2)
#&gt;  readr          * 1.3.1   2018-12-21 [1] CRAN (R 4.0.2)
#&gt;  readxl           1.3.1   2019-03-13 [1] CRAN (R 4.0.2)
#&gt;  reprex           0.3.0   2019-05-16 [1] CRAN (R 4.0.2)
#&gt;  rlang            0.4.7   2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  rmarkdown        2.3     2020-06-18 [1] CRAN (R 4.0.2)
#&gt;  rstudioapi       0.11    2020-02-07 [1] CRAN (R 4.0.2)
#&gt;  rvest            0.3.6   2020-07-25 [1] CRAN (R 4.0.2)
#&gt;  scales           1.1.1   2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  sessioninfo      1.1.1   2018-11-05 [1] CRAN (R 4.0.2)
#&gt;  stringi          1.4.6   2020-02-17 [1] CRAN (R 4.0.0)
#&gt;  stringr        * 1.4.0   2019-02-10 [1] CRAN (R 4.0.2)
#&gt;  styler           1.3.2   2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  tibble         * 3.0.3   2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  tidyr          * 1.1.1   2020-07-31 [1] CRAN (R 4.0.2)
#&gt;  tidyselect       1.1.0   2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  tidyverse      * 1.3.0   2019-11-21 [1] CRAN (R 4.0.2)
#&gt;  udpipe           0.8.3   2019-07-05 [1] CRAN (R 4.0.2)
#&gt;  vctrs            0.3.2   2020-07-15 [1] CRAN (R 4.0.2)
#&gt;  withr            2.2.0   2020-04-20 [1] CRAN (R 4.0.2)
#&gt;  xfun             0.16    2020-07-24 [1] CRAN (R 4.0.2)
#&gt;  xml2             1.3.2   2020-04-23 [1] CRAN (R 4.0.2)
#&gt;  yaml             2.2.1   2020-02-01 [1] CRAN (R 4.0.0)
#&gt;  zipangu          0.2.1   2020-07-07 [1] CRAN (R 4.0.2)
#&gt; 
#&gt; [1] C:/Users/user/Documents/R/win-library/4.0
#&gt; [2] C:/Program Files/R/R-4.0.2/library</code></pre>
</div>
