---
title: spacyr・cleanNLPのデモ
author: paithiov909
date: '2020-07-16'
lastmod: "2020-07-17"
slug: sapcyr-clenanlp-demo
categories: []
tags:
  - NLP
description: 'spacyr・cleanNLPのデモ on Windows'
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="spacyr" class="section level2">
<h2>spacyr</h2>
<div id="環境" class="section level3">
<h3>環境</h3>
<p>Windows10、Miniconda3 (Python 3.7.6 64-bit) です。</p>
</div>
<div id="spacyrについて" class="section level3">
<h3>spacyrについて</h3>
<p><a href="https://spacy.io/">spaCy</a>を{reticulate}経由で呼ぶRパッケージです。</p>
<p><a href="https://spacyr.quanteda.io/">Wrapper to the spaCy NLP Library • spacyr</a></p>
<p>spaCyは2.3で日本語のモデルが利用できるようになったらしいです。</p>
</div>
<div id="initialize" class="section level3">
<h3>Initialize</h3>
<p>簡単に導入できるのですが、Windows環境だけの罠として以下の手順はRを管理者権限で実行する必要があります。Rstudioならショートカットを右クリックから「管理者として実行」です。</p>
<blockquote>
<p>For Windows, you need to run R as an administrator to make installation work properly. To do so, right click the RStudio icon (or R desktop icon) and select “Run as administrator” when launching R.</p>
</blockquote>
<p>管理者として以下のスクリプトを実行すると、<code>spacy_condaenv</code>という名前のcondaenv内にspaCyと日本語の<code>ja_core_news_md</code>というモデルがダウンロードされます</p>
<pre class="r"><code>spacyr::spacy_install()
spacyr::spacy_download_langmodel(&quot;ja_core_news_md&quot;)</code></pre>
<p>モデルをロードして使います。</p>
<pre class="r"><code>spacyr::spacy_initialize(model = &quot;ja_core_news_md&quot;)
#&gt; Found &#39;spacy_condaenv&#39;. spacyr will use this environment
#&gt; successfully initialized (spaCy Version: 2.3.2, language model: ja_core_news_md)
#&gt; (python options: type = &quot;condaenv&quot;, value = &quot;spacy_condaenv&quot;)</code></pre>
</div>
<div id="使用例" class="section level3">
<h3>使用例</h3>
<p>日本語のモデルではlemmatizationはうまく動かないよという怒られが発生するので<code>lemma = FALSE</code>とします。</p>
<pre class="r"><code>spacyr::spacy_parse(&quot;望遠鏡で泳ぐ彼女を見た&quot;, lemma = FALSE)
#&gt;   doc_id sentence_id token_id token  pos entity
#&gt; 1  text1           1        1  望遠 NOUN       
#&gt; 2  text1           1        2    鏡 NOUN       
#&gt; 3  text1           1        3    で  ADP       
#&gt; 4  text1           1        4  泳ぐ VERB       
#&gt; 5  text1           1        5  彼女 PRON       
#&gt; 6  text1           1        6    を  ADP       
#&gt; 7  text1           1        7    見 VERB       
#&gt; 8  text1           1        8    た  AUX</code></pre>
<p>UDなので係り受けを出せます。</p>
<pre class="r"><code>spacyr::spacy_parse(&quot;望遠鏡で泳ぐ彼女を見た&quot;, dependency = TRUE, lemma = FALSE, pos = FALSE)
#&gt;   doc_id sentence_id token_id token head_token_id  dep_rel entity
#&gt; 1  text1           1        1  望遠             2 compound       
#&gt; 2  text1           1        2    鏡             4      obl       
#&gt; 3  text1           1        3    で             2     case       
#&gt; 4  text1           1        4  泳ぐ             5      acl       
#&gt; 5  text1           1        5  彼女             7      obj       
#&gt; 6  text1           1        6    を             5     case       
#&gt; 7  text1           1        7    見             7     ROOT       
#&gt; 8  text1           1        8    た             7      aux</code></pre>
<p>とくにサイズの大きいモデルを使う場合、モデルをメモリに読み込んだままだとよろしくない場合があるので、使い終わったら以下のおまじないを実行するとよいらしいです。</p>
<pre class="r"><code>spacyr::spacy_finalize()</code></pre>
</div>
</div>
<div id="cleannlp" class="section level2">
<h2>cleanNLP</h2>
<div id="cleannlpについて" class="section level3">
<h3>cleanNLPについて</h3>
<p>UDPipe、spaCy、CoreNLPをtidyに使えるよ！というRパッケージです。</p>
<p><a href="https://statsmaths.github.io/cleanNLP/">cleanNLP: A Tidy Data Model for Natural Language Processing | cleanNLP</a></p>
<p>UDPipeについてはふつうに{udpipe}をバックエンドとして使っています。spaCyとCoreNLPについてはpipでPythonライブラリを別途導入して、それをバックエンドとして使うようです（{spacyr}や{coreNLP}とは無関係）。spaCyについてはcondaenvのなかにすでにモデルをダウンロードしてあるのでそれを利用できないか試してみたのですが、手元ではうまく動かせませんでした。実質的に{udpipe}のラッパーという感じです。</p>
</div>
<div id="initialize-1" class="section level3">
<h3>Initialize</h3>
<p><code>cleanNLP::cnlp_init_udpipe</code>だけで動くようになります。脳死でも使えて便利。</p>
<pre class="r"><code>library(cleanNLP)
cleanNLP::cnlp_init_udpipe(model_name = &quot;japanese&quot;)</code></pre>
</div>
<div id="使用例-1" class="section level3">
<h3>使用例</h3>
<p>Windows環境なので文字コードをUTF-8に変換して渡す必要があります。</p>
<pre class="r"><code>annotation &lt;- cleanNLP::cnlp_annotate(input = iconv(&quot;望遠鏡で泳ぐ彼女を見た&quot;, to = &quot;UTF-8&quot;))
annotation$token
#&gt; # A tibble: 7 x 11
#&gt;   doc_id   sid tid   token token_with_ws lemma upos  xpos  feats tid_source
#&gt; *  &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
#&gt; 1      1     1 1     望遠鏡~ 望遠鏡        望遠鏡~ NOUN  NN    &lt;NA&gt;  3         
#&gt; 2      1     1 2     で    で            で    ADP   PS    &lt;NA&gt;  1         
#&gt; 3      1     1 3     泳ぐ  泳ぐ          泳ぐ  VERB  VV    &lt;NA&gt;  4         
#&gt; 4      1     1 4     彼女  彼女          彼女  PRON  NP    &lt;NA&gt;  6         
#&gt; 5      1     1 5     を    を            を    ADP   PS    &lt;NA&gt;  4         
#&gt; 6      1     1 6     見    見            見る  VERB  VV    &lt;NA&gt;  0         
#&gt; 7      1     1 7     た    た            た    AUX   AV    &lt;NA&gt;  6         
#&gt; # ... with 1 more variable: relation &lt;chr&gt;</code></pre>
</div>
</div>
<div id="セッション情報" class="section level2">
<h2>セッション情報</h2>
<pre class="r"><code>sessioninfo::session_info()
#&gt; - Session info ---------------------------------------------------------------
#&gt;  setting  value                       
#&gt;  version  R version 4.0.2 (2020-06-22)
#&gt;  os       Windows 10 x64              
#&gt;  system   x86_64, mingw32             
#&gt;  ui       RTerm                       
#&gt;  language (EN)                        
#&gt;  collate  Japanese_Japan.932          
#&gt;  ctype    Japanese_Japan.932          
#&gt;  tz       Asia/Tokyo                  
#&gt;  date     2020-07-17                  
#&gt; 
#&gt; - Packages -------------------------------------------------------------------
#&gt;  package     * version date       lib source        
#&gt;  assertthat    0.2.1   2019-03-21 [1] CRAN (R 4.0.2)
#&gt;  backports     1.1.8   2020-06-17 [1] CRAN (R 4.0.2)
#&gt;  blob          1.2.1   2020-01-20 [1] CRAN (R 4.0.2)
#&gt;  blogdown      0.20    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  bookdown      0.20    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  broom         0.7.0   2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  cellranger    1.1.0   2016-07-27 [1] CRAN (R 4.0.2)
#&gt;  cleanNLP    * 3.0.2   2020-03-08 [1] CRAN (R 4.0.2)
#&gt;  cli           2.0.2   2020-02-28 [1] CRAN (R 4.0.2)
#&gt;  colorspace    1.4-1   2019-03-18 [1] CRAN (R 4.0.2)
#&gt;  crayon        1.3.4   2017-09-16 [1] CRAN (R 4.0.2)
#&gt;  data.table    1.12.8  2019-12-09 [1] CRAN (R 4.0.0)
#&gt;  DBI           1.1.0   2019-12-15 [1] CRAN (R 4.0.2)
#&gt;  dbplyr        1.4.4   2020-05-27 [1] CRAN (R 4.0.2)
#&gt;  digest        0.6.25  2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  dplyr       * 1.0.0   2020-05-29 [1] CRAN (R 4.0.2)
#&gt;  ellipsis      0.3.1   2020-05-15 [1] CRAN (R 4.0.2)
#&gt;  evaluate      0.14    2019-05-28 [1] CRAN (R 4.0.2)
#&gt;  fansi         0.4.1   2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  forcats     * 0.5.0   2020-03-01 [1] CRAN (R 4.0.2)
#&gt;  fs            1.4.2   2020-06-30 [1] CRAN (R 4.0.2)
#&gt;  generics      0.0.2   2018-11-29 [1] CRAN (R 4.0.2)
#&gt;  ggplot2     * 3.3.2   2020-06-19 [1] CRAN (R 4.0.2)
#&gt;  glue          1.4.1   2020-05-13 [1] CRAN (R 4.0.2)
#&gt;  gtable        0.3.0   2019-03-25 [1] CRAN (R 4.0.2)
#&gt;  haven         2.3.1   2020-06-01 [1] CRAN (R 4.0.2)
#&gt;  hms           0.5.3   2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  htmltools     0.5.0   2020-06-16 [1] CRAN (R 4.0.2)
#&gt;  httr          1.4.1   2019-08-05 [1] CRAN (R 4.0.0)
#&gt;  jsonlite      1.7.0   2020-06-25 [1] CRAN (R 4.0.2)
#&gt;  knitr         1.29    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  lattice       0.20-41 2020-04-02 [2] CRAN (R 4.0.2)
#&gt;  lifecycle     0.2.0   2020-03-06 [1] CRAN (R 4.0.2)
#&gt;  lubridate     1.7.9   2020-06-08 [1] CRAN (R 4.0.2)
#&gt;  magrittr      1.5     2014-11-22 [1] CRAN (R 4.0.2)
#&gt;  Matrix        1.2-18  2019-11-27 [2] CRAN (R 4.0.2)
#&gt;  modelr        0.1.8   2020-05-19 [1] CRAN (R 4.0.2)
#&gt;  munsell       0.5.0   2018-06-12 [1] CRAN (R 4.0.2)
#&gt;  pillar        1.4.6   2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.0.2)
#&gt;  purrr       * 0.3.4   2020-04-17 [1] CRAN (R 4.0.2)
#&gt;  R.cache       0.14.0  2019-12-06 [1] CRAN (R 4.0.2)
#&gt;  R.methodsS3   1.8.0   2020-02-14 [1] CRAN (R 4.0.0)
#&gt;  R.oo          1.23.0  2019-11-03 [1] CRAN (R 4.0.0)
#&gt;  R.utils       2.9.2   2019-12-08 [1] CRAN (R 4.0.2)
#&gt;  R6            2.4.1   2019-11-12 [1] CRAN (R 4.0.2)
#&gt;  Rcpp          1.0.5   2020-07-06 [1] CRAN (R 4.0.2)
#&gt;  readr       * 1.3.1   2018-12-21 [1] CRAN (R 4.0.2)
#&gt;  readxl        1.3.1   2019-03-13 [1] CRAN (R 4.0.2)
#&gt;  reprex        0.3.0   2019-05-16 [1] CRAN (R 4.0.2)
#&gt;  reticulate    1.16    2020-05-27 [1] CRAN (R 4.0.2)
#&gt;  rlang         0.4.7   2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  rmarkdown     2.3     2020-06-18 [1] CRAN (R 4.0.2)
#&gt;  rstudioapi    0.11    2020-02-07 [1] CRAN (R 4.0.2)
#&gt;  rvest         0.3.5   2019-11-08 [1] CRAN (R 4.0.0)
#&gt;  scales        1.1.1   2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 4.0.2)
#&gt;  spacyr        1.2.1   2020-03-04 [1] CRAN (R 4.0.2)
#&gt;  stringi       1.4.6   2020-02-17 [1] CRAN (R 4.0.0)
#&gt;  stringr     * 1.4.0   2019-02-10 [1] CRAN (R 4.0.2)
#&gt;  styler        1.3.2   2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  tibble      * 3.0.3   2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  tidyr       * 1.1.0   2020-05-20 [1] CRAN (R 4.0.2)
#&gt;  tidyselect    1.1.0   2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  tidyverse   * 1.3.0   2019-11-21 [1] CRAN (R 4.0.2)
#&gt;  udpipe        0.8.3   2019-07-05 [1] CRAN (R 4.0.2)
#&gt;  utf8          1.1.4   2018-05-24 [1] CRAN (R 4.0.2)
#&gt;  vctrs         0.3.2   2020-07-15 [1] CRAN (R 4.0.2)
#&gt;  withr         2.2.0   2020-04-20 [1] CRAN (R 4.0.2)
#&gt;  xfun          0.15    2020-06-21 [1] CRAN (R 4.0.2)
#&gt;  xml2          1.3.2   2020-04-23 [1] CRAN (R 4.0.2)
#&gt;  yaml          2.2.1   2020-02-01 [1] CRAN (R 4.0.0)
#&gt; 
#&gt; [1] C:/Users/user/Documents/R/win-library/4.0
#&gt; [2] C:/Program Files/R/R-4.0.2/library</code></pre>
</div>
