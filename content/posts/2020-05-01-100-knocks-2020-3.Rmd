---
title: Rで言語処理100本ノックを解くわけがない（３）
author: paithiov909
date: '2020-05-01'
slug: 100-knocks-2020-3
categories: []
tags:
  - NLP
description: 'Rでもにょる自然言語処理'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = "styler",
  collapse = TRUE,
  comment = "#>"
)

stopifnot(require(tidyverse))
```

<!--more-->

## 係り受け解析

```{r}
temp <- tempfile(fileext = ".txt")
download.file("https://nlp100.github.io/data/neko.txt", temp)
neko <- readtext::readtext(temp, encoding = "UTF-8")
neko$text[1] %>%
    readr::read_lines(skip_empty_rows = TRUE) %>%
    length()
```

### 40. 係り受け解析結果の読み込み（形態素）

ここでも[オレオレパッケージ](https://paithiov909.github.io/pipian/)を使います。設問の通りにクラスを実装したりはしませんが、だいたい似たような情報を出力できます。

ただ、以下の処理は律儀に文の数だけCaboChaを呼んでいるため、非常に遅いです（ちゃんとやる場合、`pipian::cabochaFlatXML`に文章をまるごと渡して、戻り値のflat XMLを自分で解析したほうがよいでしょう）。ここでは、解析するのはごく一部だけにしています。

```{r}
res <- neko$text[1] %>%
    readr::read_lines(skip_empty_rows = TRUE)
res <- stringr::str_c(res[1:20], sep = " ") %>%
    iconv(from = "UTF-8", to = "CP932") %>%
    purrr::imap_dfr(function(str, sid){
      res <- pipian::cabochaFlatXML(str) %>%
        pipian::CabochaR()
      df <- res$as.tibble()
      return(
        dplyr::bind_cols(
          data.frame(sid = rep(sid, nrow(df))),
          df
        )
      )
    })

head(res)
```

3文目の形態素列

```{r}
res %>%
  dplyr::filter(sid == 3) %>%
  dplyr::select(word)
```

### 41. 係り受け解析結果の読み込み（文節・係り受け）

省きます（必要なとき都度探す感じで）。

### 42. 係り元と係り先の文節の表示

```{r}
memo <- res %>%
  dplyr::filter(POS1 != "記号") %>%
  dplyr::group_by(sid, chunk_id) %>%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = ""
    )
  ) %>%
  dplyr::ungroup() %>%
  dplyr::select(sid, chunk_id, D1, D2, chunk) %>%
  dplyr::distinct()

memo %>%
  dplyr::filter(D2 != -1) %>%
  dplyr::group_by(sid, chunk_id, D1) %>%
  dplyr::mutate(collocation = stringr::str_c(
    chunk,
    memo$chunk[memo$sid == .data$sid & memo$D1 == .data$D2],
    sep = " "
  )) %>%
  dplyr::ungroup() %>%
  dplyr::select(chunk, collocation) %>%
  head()
```

### 43. 名詞を含む文節が動詞を含む文節に係るものを抽出

```{r}
memo <- res %>%
  dplyr::group_by(sid, chunk_id) %>%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = ""
    )
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(tag = POS1 == "動詞") %>%
  dplyr::select(sid, chunk_id, D1, D2, chunk, POS1, tag) %>%
  dplyr::distinct()

memo %>%
  dplyr::filter(POS1 == "名詞") %>%
  dplyr::filter(D2 != -1) %>%
  dplyr::group_by(sid, chunk_id, D1) %>%
  dplyr::mutate(collocation = stringr::str_c(
    chunk,
    memo$chunk[memo$sid == .data$sid & memo$D1 == .data$D2 & memo$tag == TRUE],
    sep = " "
  )) %>%
  dplyr::ungroup() %>%
  dplyr::select(chunk, collocation) %>%
  dplyr::filter(chunk != collocation) %>%
  head()
```

### 44. 係り受け木の可視化

そういう関数があるのでサボります。

```{r}
graph <- neko$text[1] %>%
    readr::read_lines(skip_empty_rows = TRUE)
tbl <- graph[12] %>%
    iconv(from = "UTF-8", to = "CP932") %>%
    pipian::CabochaTbl()
tbl$plot()
```

### 45. 動詞の格パターンの抽出

```{r}
memo <- res %>%
  dplyr::select(sid, chunk_id, D1, D2, POS1, Original)

pattern <- memo %>%
  dplyr::filter(POS1 == "動詞") %>%
  dplyr::group_by(sid, chunk_id, D1) %>%
  dplyr::mutate(collocation = stringr::str_c(
    "",
    memo$Original[memo$sid == .data$sid & memo$D2 == .data$D1 & memo$POS1 == "助詞"],
    collapse = " "
  )) %>%
  dplyr::ungroup() %>%
  dplyr::select(Original, collocation)

pattern
```

「する」「見る」「与える」という動詞の格パターン

```{r}
pattern %>%
  dplyr::filter(Original %in% c("する", "見る", "与える")) %>%
  dplyr::group_by(Original, collocation) %>%
  dplyr::count()
```

### 46. 動詞の格フレーム情報の抽出

これを見ると「だけは」みたいな助詞の連続が要件通りに表示できていないことがわかりますが、もう疲れたのであきらめます。

```{r}
memo <- res %>%
  dplyr::group_by(sid, chunk_id) %>%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = ""
  )) %>%
  dplyr::ungroup() %>%
  dplyr::select(sid, chunk_id, D1, D2, POS1, Original, chunk)

pattern <- memo %>%
  dplyr::filter(POS1 == "動詞") %>%
  dplyr::group_by(sid, chunk_id, D1) %>%
  dplyr::mutate(collocation = stringr::str_c(
    "",
    memo$Original[memo$sid == .data$sid & memo$D2 == .data$D1 & memo$POS1 == "助詞"],
    collapse = " "
  )) %>%
  dplyr::mutate(chunk = stringr::str_c(
    "",
    memo$chunk[memo$sid == .data$sid & memo$D2 == .data$D1 & memo$POS1 == "助詞"],
    collapse = " "
  )) %>%
  dplyr::ungroup() %>%
  dplyr::select(Original, collocation, chunk)

pattern
```

以下略

## セッション情報

```{r}
devtools::session_info()
```

