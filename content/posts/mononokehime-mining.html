---
title: もののけ姫を題材にした格パターンマイニングのお試し
author: paithiov909
date: '2020-07-19'
lastmod: "2020-07-22"
slug: mononokehime-mining
categories: []
tags:
  - NLP
description: '「AをBにする」という構文を抽出してみてる'
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="台詞の取得" class="section level2">
<h2>台詞の取得</h2>
<p>もののけ姫の台詞を題材にしてみる。</p>
<p>有名どころのジブリ作品だとファンが台詞をすべて書き起こして公開していたりする。すべて読めてしまうのは権利的にどうなのかというのはあるが、ググると出てくるのであまり深く考えないことにした。</p>
<pre class="r"><code>## &#39;キャラ名「セリフ(ある場合、読みがな)」&#39;という形式で書かれている
sentences &lt;- URL %&gt;%
  rvest::html_session() %&gt;%
  rvest::html_nodes(&quot;p.serif&quot;) %&gt;%
  rvest::html_text(trim = TRUE) %&gt;%
  stringr::str_replace_all(enc2utf8(&quot;\u300d&quot;), &quot;&quot;) %&gt;%
  stringr::str_replace_all(&quot;\\([ぁ-ん]+\\)&quot;, &quot;&quot;) %&gt;%
  stringr::str_split(fixed(enc2utf8(&quot;\u300c&quot;))) %&gt;%
  purrr::keep(. != &quot;&quot;) %&gt;%
  purrr::keep(~ length(.) == 2) %&gt;%
  purrr::map_dfr(~ tibble::tibble(
    character = .[1],
    sentence = .[2]
  ))</code></pre>
</div>
<div id="前処理" class="section level2">
<h2>前処理</h2>
<p>いわゆる注ぎ足しのタレ。今回の題材についてはそんなに重要じゃない気もする。</p>
<pre class="r"><code>normalize &lt;- function(str) {
  str %&gt;%
    stringr::str_replace_all(&quot;\u2019&quot;, &quot;\&#39;&quot;) %&gt;%
    stringr::str_replace_all(&quot;\u201d&quot;, &quot;\&quot;&quot;) %&gt;%
    stringr::str_replace_all(&quot;[\u02d7\u058a\u2010\u2011\u2012\u2013\u2043\u207b\u208b\u2212]&quot;, &quot;-&quot;) %&gt;%
    stringr::str_replace_all(&quot;[\ufe63\uff0d\uff70\u2014\u2015\u2500\u2501\u30fc]&quot;, enc2utf8(&quot;\u30fc&quot;)) %&gt;%
    stringr::str_replace_all(&quot;[~\u223c\u223e\u301c\u3030\uff5e]&quot;, &quot;~&quot;) %&gt;%
    stringr::str_replace_all(&quot;[\\.]+&quot;, enc2utf8(&quot;\u2026\u2026&quot;)) %&gt;%
    stringr::str_remove_all(&quot;[:blank:]&quot;) %&gt;%
    stringr::str_remove_all(&quot;[:cntrl:]&quot;) %&gt;%
    return()
}

doc &lt;- sentences %&gt;%
  dplyr::mutate(sentence = zipangu::str_conv_normalize(sentence)) %&gt;%
  dplyr::mutate(text = normalize(sentence)) %&gt;%
  dplyr::mutate(character = as.factor(character)) %&gt;%
  tibble::rowid_to_column(&quot;doc_id&quot;)</code></pre>
<p>{udpipe}で解析する。</p>
<pre class="r"><code>annotation &lt;- udpipe::udpipe(doc, object = &quot;japanese&quot;)
annotation &lt;- doc %&gt;%
  dplyr::select(doc_id, character) %&gt;%
  dplyr::mutate(doc_id = as.character(doc_id)) %&gt;%
  dplyr::left_join(annotation, by = &quot;doc_id&quot;)</code></pre>
<p>プロットして解析結果を確認してみる。見た感じ、そこそこ正しそう。</p>
<pre class="r"><code>textplot::textplot_dependencyparser(
  dplyr::filter(annotation, doc_id == &quot;48&quot; &amp; sentence_id == &quot;7&quot;)
)
#&gt;  要求されたパッケージ ggraph をロード中です</code></pre>
<p><img src="/post/mononokehime-mining_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>ただ、漢字がひらがなに開かれている箇所には弱そうかもしれない。</p>
<pre class="r"><code>textplot::textplot_dependencyparser(
  dplyr::filter(annotation, doc_id == &quot;48&quot; &amp; sentence_id == &quot;1&quot;)
)</code></pre>
<p><img src="/post/mononokehime-mining_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="keywordscollocation-extraction" class="section level2">
<h2>Keywords(collocation) extraction</h2>
<p>こんな感じでコロケーションをキーワードとして抽出できる。</p>
<pre class="r"><code>udpipe::keywords_collocation(
  dplyr::filter(annotation, upos %in% c(&quot;PROPN&quot;, &quot;NOUN&quot;)),
  term = &quot;lemma&quot;,
  group = c(&quot;doc_id&quot;, &quot;sentence_id&quot;),
  ngram_max = 4L
) %&gt;%
  dplyr::select(1:7) %&gt;%
  dplyr::top_n(10, desc(freq)) %&gt;%
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">keyword</th>
<th align="right">ngram</th>
<th align="left">left</th>
<th align="left">right</th>
<th align="right">freq</th>
<th align="right">freq_left</th>
<th align="right">freq_right</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">乙事 主さま</td>
<td align="right">2</td>
<td align="left">乙事</td>
<td align="left">主さま</td>
<td align="right">3</td>
<td align="right">4</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">乙 事主</td>
<td align="right">2</td>
<td align="left">乙</td>
<td align="left">事主</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">タタラ 場</td>
<td align="right">2</td>
<td align="left">タタラ</td>
<td align="left">場</td>
<td align="right">3</td>
<td align="right">9</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">ケガ 人</td>
<td align="right">2</td>
<td align="left">ケガ</td>
<td align="left">人</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">11</td>
</tr>
<tr class="odd">
<td align="left">ジコ 坊 さま</td>
<td align="right">3</td>
<td align="left">ジコ 坊</td>
<td align="left">さま</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">お トキ さん</td>
<td align="right">3</td>
<td align="left">お トキ</td>
<td align="left">さん</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">トキ さん</td>
<td align="right">2</td>
<td align="left">トキ</td>
<td align="left">さん</td>
<td align="right">3</td>
<td align="right">9</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">坊 さま</td>
<td align="right">2</td>
<td align="left">坊</td>
<td align="left">さま</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">17</td>
</tr>
<tr class="odd">
<td align="left">シシ神 首</td>
<td align="right">2</td>
<td align="left">シシ神</td>
<td align="left">首</td>
<td align="right">3</td>
<td align="right">45</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">男 たち</td>
<td align="right">2</td>
<td align="left">男</td>
<td align="left">たち</td>
<td align="right">3</td>
<td align="right">9</td>
<td align="right">37</td>
</tr>
<tr class="odd">
<td align="left">シシ神 さま</td>
<td align="right">2</td>
<td align="left">シシ神</td>
<td align="left">さま</td>
<td align="right">3</td>
<td align="right">45</td>
<td align="right">17</td>
</tr>
</tbody>
</table>
<p>適当に助詞と動詞のコロケーションを抽出した。このなかから「を に する」という表現に注目してみることにする。</p>
<pre class="r"><code>words &lt;- udpipe::keywords_collocation(
  dplyr::filter(annotation, upos %in% c(&quot;SCONJ&quot;, &quot;ADP&quot;, &quot;VERB&quot;)),
  term = &quot;lemma&quot;,
  group = c(&quot;doc_id&quot;, &quot;sentence_id&quot;),
  ngram_max = 6L
)

words %&gt;%
  dplyr::select(1:7) %&gt;%
  dplyr::top_n(10, desc(freq)) %&gt;%
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">keyword</th>
<th align="right">ngram</th>
<th align="left">left</th>
<th align="left">right</th>
<th align="right">freq</th>
<th align="right">freq_left</th>
<th align="right">freq_right</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">こと に なる</td>
<td align="right">3</td>
<td align="left">こと に</td>
<td align="left">なる</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">22</td>
</tr>
<tr class="even">
<td align="left">へ 行く</td>
<td align="right">2</td>
<td align="left">へ</td>
<td align="left">行く</td>
<td align="right">3</td>
<td align="right">31</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">を に する</td>
<td align="right">3</td>
<td align="left">を に</td>
<td align="left">する</td>
<td align="right">3</td>
<td align="right">7</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="left">なる て も</td>
<td align="right">3</td>
<td align="left">なる て</td>
<td align="left">も</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">51</td>
</tr>
<tr class="odd">
<td align="left">は に いる</td>
<td align="right">3</td>
<td align="left">は に</td>
<td align="left">いる</td>
<td align="right">3</td>
<td align="right">13</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="left">に さわる</td>
<td align="right">2</td>
<td align="left">に</td>
<td align="left">さわる</td>
<td align="right">3</td>
<td align="right">201</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">に 乗る</td>
<td align="right">2</td>
<td align="left">に</td>
<td align="left">乗る</td>
<td align="right">3</td>
<td align="right">201</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">かえる が</td>
<td align="right">2</td>
<td align="left">かえる</td>
<td align="left">が</td>
<td align="right">3</td>
<td align="right">7</td>
<td align="right">91</td>
</tr>
<tr class="odd">
<td align="left">ため に</td>
<td align="right">2</td>
<td align="left">ため</td>
<td align="left">に</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">128</td>
</tr>
<tr class="even">
<td align="left">の が ある</td>
<td align="right">3</td>
<td align="left">の が</td>
<td align="left">ある</td>
<td align="right">3</td>
<td align="right">23</td>
<td align="right">19</td>
</tr>
<tr class="odd">
<td align="left">に の が</td>
<td align="right">3</td>
<td align="left">に の</td>
<td align="left">が</td>
<td align="right">3</td>
<td align="right">8</td>
<td align="right">56</td>
</tr>
<tr class="even">
<td align="left">に は いる</td>
<td align="right">3</td>
<td align="left">に は</td>
<td align="left">いる</td>
<td align="right">3</td>
<td align="right">19</td>
<td align="right">24</td>
</tr>
<tr class="odd">
<td align="left">こそ を</td>
<td align="right">2</td>
<td align="left">こそ</td>
<td align="left">を</td>
<td align="right">3</td>
<td align="right">4</td>
<td align="right">178</td>
</tr>
<tr class="even">
<td align="left">は うける</td>
<td align="right">2</td>
<td align="left">は</td>
<td align="left">うける</td>
<td align="right">3</td>
<td align="right">240</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">も の が</td>
<td align="right">3</td>
<td align="left">も の</td>
<td align="left">が</td>
<td align="right">3</td>
<td align="right">9</td>
<td align="right">56</td>
</tr>
<tr class="even">
<td align="left">つれる て</td>
<td align="right">2</td>
<td align="left">つれる</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">ねらう て</td>
<td align="right">2</td>
<td align="left">ねらう</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">263</td>
</tr>
<tr class="even">
<td align="left">やめる て</td>
<td align="right">2</td>
<td align="left">やめる</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">知る て</td>
<td align="right">2</td>
<td align="left">知る</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">263</td>
</tr>
<tr class="even">
<td align="left">行う て</td>
<td align="right">2</td>
<td align="left">行う</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">と いう の</td>
<td align="right">3</td>
<td align="left">と いう</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">4</td>
<td align="right">137</td>
</tr>
<tr class="even">
<td align="left">を たのむ</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">たのむ</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">が 生きる て</td>
<td align="right">3</td>
<td align="left">が 生きる</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">3</td>
<td align="right">204</td>
</tr>
<tr class="even">
<td align="left">いう の</td>
<td align="right">2</td>
<td align="left">いう</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">201</td>
</tr>
<tr class="odd">
<td align="left">わたし の</td>
<td align="right">2</td>
<td align="left">わたし</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">201</td>
</tr>
<tr class="even">
<td align="left">を おそう</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">おそう</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">を だす</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">だす</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">を 呼ぶ</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">呼ぶ</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">を 待つ て</td>
<td align="right">3</td>
<td align="left">を 待つ</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">4</td>
<td align="right">204</td>
</tr>
<tr class="even">
<td align="left">は できる</td>
<td align="right">2</td>
<td align="left">は</td>
<td align="left">できる</td>
<td align="right">3</td>
<td align="right">240</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">に いく</td>
<td align="right">2</td>
<td align="left">に</td>
<td align="left">いく</td>
<td align="right">3</td>
<td align="right">201</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">と 言う</td>
<td align="right">2</td>
<td align="left">と</td>
<td align="left">言う</td>
<td align="right">3</td>
<td align="right">109</td>
<td align="right">12</td>
</tr>
<tr class="odd">
<td align="left">たつ て</td>
<td align="right">2</td>
<td align="left">たつ</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">5</td>
<td align="right">263</td>
</tr>
<tr class="even">
<td align="left">を もつ</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">もつ</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">5</td>
</tr>
<tr class="odd">
<td align="left">は に は</td>
<td align="right">3</td>
<td align="left">は に</td>
<td align="left">は</td>
<td align="right">3</td>
<td align="right">13</td>
<td align="right">78</td>
</tr>
<tr class="even">
<td align="left">帰る て</td>
<td align="right">2</td>
<td align="left">帰る</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">6</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">する ん</td>
<td align="right">2</td>
<td align="left">する</td>
<td align="left">ん</td>
<td align="right">3</td>
<td align="right">47</td>
<td align="right">34</td>
</tr>
<tr class="even">
<td align="left">こと が</td>
<td align="right">2</td>
<td align="left">こと</td>
<td align="left">が</td>
<td align="right">3</td>
<td align="right">18</td>
<td align="right">91</td>
</tr>
<tr class="odd">
<td align="left">が 生きる</td>
<td align="right">2</td>
<td align="left">が</td>
<td align="left">生きる</td>
<td align="right">3</td>
<td align="right">186</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">の を する</td>
<td align="right">3</td>
<td align="left">の を</td>
<td align="left">する</td>
<td align="right">3</td>
<td align="right">44</td>
<td align="right">29</td>
</tr>
<tr class="odd">
<td align="left">を 守る て</td>
<td align="right">3</td>
<td align="left">を 守る</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">7</td>
<td align="right">204</td>
</tr>
<tr class="even">
<td align="left">殺す の</td>
<td align="right">2</td>
<td align="left">殺す</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">11</td>
<td align="right">201</td>
</tr>
<tr class="odd">
<td align="left">こと に</td>
<td align="right">2</td>
<td align="left">こと</td>
<td align="left">に</td>
<td align="right">3</td>
<td align="right">18</td>
<td align="right">128</td>
</tr>
<tr class="even">
<td align="left">の だけ</td>
<td align="right">2</td>
<td align="left">の</td>
<td align="left">だけ</td>
<td align="right">3</td>
<td align="right">332</td>
<td align="right">7</td>
</tr>
<tr class="odd">
<td align="left">の の を</td>
<td align="right">3</td>
<td align="left">の の</td>
<td align="left">を</td>
<td align="right">3</td>
<td align="right">20</td>
<td align="right">86</td>
</tr>
<tr class="even">
<td align="left">が いる の</td>
<td align="right">3</td>
<td align="left">が いる</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">13</td>
<td align="right">137</td>
</tr>
<tr class="odd">
<td align="left">守る て</td>
<td align="right">2</td>
<td align="left">守る</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">10</td>
<td align="right">263</td>
</tr>
<tr class="even">
<td align="left">て の に</td>
<td align="right">3</td>
<td align="left">て の</td>
<td align="left">に</td>
<td align="right">3</td>
<td align="right">23</td>
<td align="right">78</td>
</tr>
<tr class="odd">
<td align="left">は の と</td>
<td align="right">3</td>
<td align="left">は の</td>
<td align="left">と</td>
<td align="right">3</td>
<td align="right">31</td>
<td align="right">64</td>
</tr>
<tr class="even">
<td align="left">に する て</td>
<td align="right">3</td>
<td align="left">に する</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">10</td>
<td align="right">204</td>
</tr>
<tr class="odd">
<td align="left">の に も</td>
<td align="right">3</td>
<td align="left">の に</td>
<td align="left">も</td>
<td align="right">3</td>
<td align="right">41</td>
<td align="right">51</td>
</tr>
<tr class="even">
<td align="left">見る て</td>
<td align="right">2</td>
<td align="left">見る</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">12</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">を やる</td>
<td align="right">2</td>
<td align="left">を</td>
<td align="left">やる</td>
<td align="right">3</td>
<td align="right">295</td>
<td align="right">11</td>
</tr>
<tr class="even">
<td align="left">する て の</td>
<td align="right">3</td>
<td align="left">する て</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">17</td>
<td align="right">137</td>
</tr>
<tr class="odd">
<td align="left">の は に</td>
<td align="right">3</td>
<td align="left">の は</td>
<td align="left">に</td>
<td align="right">3</td>
<td align="right">32</td>
<td align="right">78</td>
</tr>
<tr class="even">
<td align="left">から が</td>
<td align="right">2</td>
<td align="left">から</td>
<td align="left">が</td>
<td align="right">3</td>
<td align="right">44</td>
<td align="right">91</td>
</tr>
<tr class="odd">
<td align="left">ば の</td>
<td align="right">2</td>
<td align="left">ば</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">20</td>
<td align="right">201</td>
</tr>
<tr class="even">
<td align="left">わかる て</td>
<td align="right">2</td>
<td align="left">わかる</td>
<td align="left">て</td>
<td align="right">3</td>
<td align="right">16</td>
<td align="right">263</td>
</tr>
<tr class="odd">
<td align="left">の が の</td>
<td align="right">3</td>
<td align="left">の が</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">23</td>
<td align="right">137</td>
</tr>
<tr class="even">
<td align="left">が で</td>
<td align="right">2</td>
<td align="left">が</td>
<td align="left">で</td>
<td align="right">3</td>
<td align="right">186</td>
<td align="right">28</td>
</tr>
<tr class="odd">
<td align="left">へ の</td>
<td align="right">2</td>
<td align="left">へ</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">31</td>
<td align="right">201</td>
</tr>
<tr class="even">
<td align="left">の は の</td>
<td align="right">3</td>
<td align="left">の は</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">32</td>
<td align="right">137</td>
</tr>
<tr class="odd">
<td align="left">が する</td>
<td align="right">2</td>
<td align="left">が</td>
<td align="left">する</td>
<td align="right">3</td>
<td align="right">186</td>
<td align="right">42</td>
</tr>
<tr class="even">
<td align="left">の に の</td>
<td align="right">3</td>
<td align="left">の に</td>
<td align="left">の</td>
<td align="right">3</td>
<td align="right">41</td>
<td align="right">137</td>
</tr>
<tr class="odd">
<td align="left">て に</td>
<td align="right">2</td>
<td align="left">て</td>
<td align="left">に</td>
<td align="right">3</td>
<td align="right">267</td>
<td align="right">128</td>
</tr>
</tbody>
</table>
<p>具体的にどのような表現として出現しているのか確認するために、「を に する」という表現を力技で抽出する（それぞれの文をパースしているわけではないので、そうは言っていない表現も拾ってしまうので注意）。</p>
<pre class="r"><code>d &lt;- udpipe::udpipe(
  iconv(&quot;折り紙を折って紙飛行機にする&quot;, to = &quot;UTF-8&quot;),
  object = &quot;japanese&quot;
)

extract_collocation &lt;- function(d) {
  res &lt;- d %&gt;%
    dplyr::rowwise() %&gt;%
    dplyr::mutate(head_token = ifelse(
      .data[[&quot;head_token_id&quot;]] == &quot;0&quot;,
      &quot;EOS&quot;,
      subset(d, token_id == .data[[&quot;head_token_id&quot;]])$token
    )) %&gt;%
    dplyr::group_by(doc_id, sentence_id) %&gt;%
    dplyr::group_map(function(sentence, keys) {
      cond &lt;- sentence %&gt;%
        dplyr::pull(lemma) %&gt;%
        stringr::str_c(collapse = &quot;\t&quot;) %&gt;%
        purrr::map(~ ifelse(all(c(
          stringr::str_detect(., &quot;\tを&quot;),
          stringr::str_detect(., &quot;\tに&quot;),
          stringr::str_detect(., &quot;\tする&quot;)
        )),
        TRUE,
        FALSE
        )) %&gt;%
        purrr::flatten_lgl()

      return(
        ifelse(
          cond,
          stringr::str_c(
            keys[, 1],
            &quot;:&quot;,
            sentence %&gt;%
              dplyr::mutate(heading = lag(token, 1)) %&gt;%
              dplyr::filter(token == &quot;を&quot;) %&gt;%
              dplyr::pull(heading),
            &quot;を&quot;,
            sentence %&gt;%
              dplyr::mutate(heading = lag(token, 1)) %&gt;%
              dplyr::filter(token == &quot;に&quot;) %&gt;%
              dplyr::pull(heading),
            &quot;に&quot;,
            sentence %&gt;%
              dplyr::filter(lemma == &quot;する&quot;) %&gt;%
              dplyr::pull(lemma),
            sep = &quot; &quot;,
            collapse = &quot;;&quot;
          ),
          character(0)
        )
      )
    }) %&gt;%
    purrr::map_dfr(~ tibble::tibble(collocation = .))
  return(res)
}

extract_collocation(d)
#&gt; # A tibble: 1 x 1
#&gt;   collocation                
#&gt;   &lt;chr&gt;                      
#&gt; 1 doc1 : 紙 を 飛行機 に する</code></pre>
<p>こうなる。</p>
<pre class="r"><code>annotation %&gt;%
  extract_collocation() %&gt;%
  tidyr::drop_na() %&gt;%
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">collocation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">191 : 骨 を タタリ神 に する;191 : くだき肉 を タタリ神 に する</td>
</tr>
<tr class="even">
<td align="left">205 : 森 を タタリ神 に する;205 : 呪い を タタリ神 に する</td>
</tr>
<tr class="odd">
<td align="left">211 : 力 を ここ に する</td>
</tr>
<tr class="even">
<td align="left">282 : 山犬 を 嫁 に する</td>
</tr>
<tr class="odd">
<td align="left">298 : おもどり を 敵 に する</td>
</tr>
<tr class="even">
<td align="left">374 : 母さん を バカ に する</td>
</tr>
<tr class="odd">
<td align="left">569 : 場 を 見殺し に する</td>
</tr>
<tr class="even">
<td align="left">570 : 帰り を おくれ に する</td>
</tr>
<tr class="odd">
<td align="left">669 : 備え を 女たち に する</td>
</tr>
<tr class="even">
<td align="left">808 : ここ を 村 に する</td>
</tr>
</tbody>
</table>
</div>
<div id="セッション情報" class="section level2">
<h2>セッション情報</h2>
<pre class="r"><code>sessioninfo::session_info()
#&gt; - Session info ---------------------------------------------------------------
#&gt;  setting  value                       
#&gt;  version  R version 4.0.2 (2020-06-22)
#&gt;  os       Windows 10 x64              
#&gt;  system   x86_64, mingw32             
#&gt;  ui       RTerm                       
#&gt;  language (EN)                        
#&gt;  collate  Japanese_Japan.932          
#&gt;  ctype    Japanese_Japan.932          
#&gt;  tz       Asia/Tokyo                  
#&gt;  date     2020-07-22                  
#&gt; 
#&gt; - Packages -------------------------------------------------------------------
#&gt;  package      * version  date       lib source        
#&gt;  assertthat     0.2.1    2019-03-21 [1] CRAN (R 4.0.2)
#&gt;  backports      1.1.8    2020-06-17 [1] CRAN (R 4.0.2)
#&gt;  blob           1.2.1    2020-01-20 [1] CRAN (R 4.0.2)
#&gt;  blogdown       0.20     2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  bookdown       0.20     2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  broom          0.7.0    2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  cellranger     1.1.0    2016-07-27 [1] CRAN (R 4.0.2)
#&gt;  cli            2.0.2    2020-02-28 [1] CRAN (R 4.0.2)
#&gt;  colorspace     1.4-1    2019-03-18 [1] CRAN (R 4.0.2)
#&gt;  crayon         1.3.4    2017-09-16 [1] CRAN (R 4.0.2)
#&gt;  curl           4.3      2019-12-02 [1] CRAN (R 4.0.2)
#&gt;  data.table     1.12.8   2019-12-09 [1] CRAN (R 4.0.0)
#&gt;  DBI            1.1.0    2019-12-15 [1] CRAN (R 4.0.2)
#&gt;  dbplyr         1.4.4    2020-05-27 [1] CRAN (R 4.0.2)
#&gt;  digest         0.6.25   2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  dplyr        * 1.0.0    2020-05-29 [1] CRAN (R 4.0.2)
#&gt;  ellipsis       0.3.1    2020-05-15 [1] CRAN (R 4.0.2)
#&gt;  evaluate       0.14     2019-05-28 [1] CRAN (R 4.0.2)
#&gt;  fansi          0.4.1    2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  farver         2.0.3    2020-01-16 [1] CRAN (R 4.0.2)
#&gt;  forcats      * 0.5.0    2020-03-01 [1] CRAN (R 4.0.2)
#&gt;  fs             1.4.2    2020-06-30 [1] CRAN (R 4.0.2)
#&gt;  generics       0.0.2    2018-11-29 [1] CRAN (R 4.0.2)
#&gt;  ggforce        0.3.2    2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  ggplot2      * 3.3.2    2020-06-19 [1] CRAN (R 4.0.2)
#&gt;  ggraph         2.0.3    2020-05-20 [1] CRAN (R 4.0.2)
#&gt;  ggrepel        0.8.2    2020-03-08 [1] CRAN (R 4.0.2)
#&gt;  glue           1.4.1    2020-05-13 [1] CRAN (R 4.0.2)
#&gt;  graphlayouts   0.7.0    2020-04-25 [1] CRAN (R 4.0.2)
#&gt;  gridExtra      2.3      2017-09-09 [1] CRAN (R 4.0.2)
#&gt;  gtable         0.3.0    2019-03-25 [1] CRAN (R 4.0.2)
#&gt;  haven          2.3.1    2020-06-01 [1] CRAN (R 4.0.2)
#&gt;  highr          0.8      2019-03-20 [1] CRAN (R 4.0.2)
#&gt;  hms            0.5.3    2020-01-08 [1] CRAN (R 4.0.2)
#&gt;  htmltools      0.5.0    2020-06-16 [1] CRAN (R 4.0.2)
#&gt;  httr           1.4.1    2019-08-05 [1] CRAN (R 4.0.0)
#&gt;  igraph         1.2.5    2020-03-19 [1] CRAN (R 4.0.2)
#&gt;  jsonlite       1.7.0    2020-06-25 [1] CRAN (R 4.0.2)
#&gt;  knitr          1.29     2020-06-23 [1] CRAN (R 4.0.2)
#&gt;  labeling       0.3      2014-08-23 [1] CRAN (R 4.0.0)
#&gt;  lattice        0.20-41  2020-04-02 [2] CRAN (R 4.0.2)
#&gt;  lifecycle      0.2.0    2020-03-06 [1] CRAN (R 4.0.2)
#&gt;  lubridate      1.7.9    2020-06-08 [1] CRAN (R 4.0.2)
#&gt;  magrittr       1.5      2014-11-22 [1] CRAN (R 4.0.2)
#&gt;  MASS           7.3-51.6 2020-04-26 [2] CRAN (R 4.0.2)
#&gt;  Matrix         1.2-18   2019-11-27 [2] CRAN (R 4.0.2)
#&gt;  modelr         0.1.8    2020-05-19 [1] CRAN (R 4.0.2)
#&gt;  munsell        0.5.0    2018-06-12 [1] CRAN (R 4.0.2)
#&gt;  pillar         1.4.6    2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  pkgconfig      2.0.3    2019-09-22 [1] CRAN (R 4.0.2)
#&gt;  polyclip       1.10-0   2019-03-14 [1] CRAN (R 4.0.0)
#&gt;  purrr        * 0.3.4    2020-04-17 [1] CRAN (R 4.0.2)
#&gt;  R.cache        0.14.0   2019-12-06 [1] CRAN (R 4.0.2)
#&gt;  R.methodsS3    1.8.0    2020-02-14 [1] CRAN (R 4.0.0)
#&gt;  R.oo           1.23.0   2019-11-03 [1] CRAN (R 4.0.0)
#&gt;  R.utils        2.9.2    2019-12-08 [1] CRAN (R 4.0.2)
#&gt;  R6             2.4.1    2019-11-12 [1] CRAN (R 4.0.2)
#&gt;  Rcpp           1.0.5    2020-07-06 [1] CRAN (R 4.0.2)
#&gt;  readr        * 1.3.1    2018-12-21 [1] CRAN (R 4.0.2)
#&gt;  readxl         1.3.1    2019-03-13 [1] CRAN (R 4.0.2)
#&gt;  reprex         0.3.0    2019-05-16 [1] CRAN (R 4.0.2)
#&gt;  rlang          0.4.7    2020-07-09 [1] CRAN (R 4.0.2)
#&gt;  rmarkdown      2.3      2020-06-18 [1] CRAN (R 4.0.2)
#&gt;  rstudioapi     0.11     2020-02-07 [1] CRAN (R 4.0.2)
#&gt;  rvest          0.3.5    2019-11-08 [1] CRAN (R 4.0.0)
#&gt;  scales         1.1.1    2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  selectr        0.4-2    2019-11-20 [1] CRAN (R 4.0.2)
#&gt;  sessioninfo    1.1.1    2018-11-05 [1] CRAN (R 4.0.2)
#&gt;  stringi        1.4.6    2020-02-17 [1] CRAN (R 4.0.0)
#&gt;  stringr      * 1.4.0    2019-02-10 [1] CRAN (R 4.0.2)
#&gt;  styler         1.3.2    2020-02-23 [1] CRAN (R 4.0.2)
#&gt;  textplot       0.1.3    2020-06-18 [1] CRAN (R 4.0.2)
#&gt;  tibble       * 3.0.3    2020-07-10 [1] CRAN (R 4.0.2)
#&gt;  tidygraph      1.2.0    2020-05-12 [1] CRAN (R 4.0.2)
#&gt;  tidyr        * 1.1.0    2020-05-20 [1] CRAN (R 4.0.2)
#&gt;  tidyselect     1.1.0    2020-05-11 [1] CRAN (R 4.0.2)
#&gt;  tidyverse    * 1.3.0    2019-11-21 [1] CRAN (R 4.0.2)
#&gt;  tweenr         1.0.1    2018-12-14 [1] CRAN (R 4.0.2)
#&gt;  udpipe         0.8.3    2019-07-05 [1] CRAN (R 4.0.2)
#&gt;  utf8           1.1.4    2018-05-24 [1] CRAN (R 4.0.2)
#&gt;  vctrs          0.3.2    2020-07-15 [1] CRAN (R 4.0.2)
#&gt;  viridis        0.5.1    2018-03-29 [1] CRAN (R 4.0.2)
#&gt;  viridisLite    0.3.0    2018-02-01 [1] CRAN (R 4.0.2)
#&gt;  withr          2.2.0    2020-04-20 [1] CRAN (R 4.0.2)
#&gt;  xfun           0.15     2020-06-21 [1] CRAN (R 4.0.2)
#&gt;  xml2           1.3.2    2020-04-23 [1] CRAN (R 4.0.2)
#&gt;  yaml           2.2.1    2020-02-01 [1] CRAN (R 4.0.0)
#&gt;  zipangu        0.2.1    2020-07-07 [1] CRAN (R 4.0.2)
#&gt; 
#&gt; [1] C:/Users/user/Documents/R/win-library/4.0
#&gt; [2] C:/Program Files/R/R-4.0.2/library</code></pre>
</div>
