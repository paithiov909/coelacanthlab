---
title: 短歌時評のテキスト解析（１）
author: paithiov909
date: '2020-05-20'
slug: scraping-tanka-jihyo
categories: []
tags:
  - Preprocessing
description: 'Rでもにょる自然言語処理'
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="解説" class="section level2">
<h2>解説</h2>
<blockquote>
<p><a href="https://note.com/shinabitanori/n/nfbcb659d6134">短歌時評のテキスト解析｜さちこ｜note</a></p>
</blockquote>
<!--more-->
</div>
<div id="短歌結社誌サイトの時評のスクレイピング" class="section level2">
<h2>短歌結社誌サイトの時評のスクレイピング</h2>
<p>以下の２誌のサイトからネットに公開済みの時評を収集します。</p>
<ul>
<li><a href="http://www.miraitankakai.com/comments.html">未来　時評</a></li>
<li><a href="http://toutankakai.com/magazine/category/tanka_jihyo/">短歌時評 | カテゴリ | 塔短歌会</a></li>
</ul>
</div>
<div id="未来" class="section level2">
<h2>未来</h2>
<div id="未来のサイトのhtml構造" class="section level3">
<h3>未来のサイトのHTML構造</h3>
<p>ホームページ・ビルダー製で、昔ながらのtableタグで組まれたペライチのページ内に時評がまとめて掲載されています。ページ遷移をする必要がない点では楽に収集できますが、記事単位をマークアップしている構造がないため、文書を分けるのに一工夫必要です。</p>
<pre class="html"><code>
&lt;!-- ...省略... --&gt;

&lt;DIV align=&quot;center&quot;&gt;
  &lt;table width=&quot;798&quot;&gt;
    &lt;col span=&quot;2&quot; width=&quot;10&quot;&gt;
    &lt;col span=&quot;1&quot; width=&quot;780&quot;&gt;
    &lt;TBODY&gt;
      &lt;TR&gt;
        &lt;td align=&quot;left&quot; colspan=&quot;8&quot; width=&quot;792&quot;&gt;
        &lt;P class=&quot;MsoNormal&quot; align=&quot;left&quot;&gt;&lt;b&gt;&lt;font size=&quot;3&quot; face=&quot;ＭＳ Ｐゴシック&quot;&gt;時評&lt;br&gt;
        &lt;/font&gt;&lt;/b&gt;&lt;/font&gt;&lt;/P&gt;
        &lt;/td&gt;
      &lt;/TR&gt;
      &lt;TR&gt;
        &lt;td align=&quot;left&quot; colspan=&quot;8&quot;&gt;&lt;b&gt;&lt;span lang=&quot;EN-US&quot; &gt;2020&lt;/span&gt;&lt;span &gt;年&lt;span lang=&quot;EN-US&quot;&gt;&lt;/span&gt;5月号&lt;/span&gt;&lt;/b&gt;&lt;/td&gt;
      &lt;/TR&gt;
      &lt;TR&gt;
        &lt;td align=&quot;left&quot; colspan=&quot;8&quot;&gt;&lt;b&gt;&lt;span lang=&quot;EN-US&quot;&gt;&lt;span&gt;『乱反射する「母」と「ラブ」』　　　山崎聡子&lt;/span&gt;&lt;/span&gt;&lt;/b&gt;&lt;/td&gt;
      &lt;/TR&gt;
      &lt;TR&gt;
        &lt;td align=&quot;left&quot; colspan=&quot;8&quot;&gt;
        &lt;!--
            &lt;p class=&quot;MsoNormal&quot; align=&quot;left&quot;&gt;&lt;/p&gt;
        --&gt;
        &lt;/td&gt;
      &lt;/TR&gt;

&lt;!-- ...省略... --&gt;
</code></pre>
</div>
<div id="スクレイピング" class="section level3">
<h3>スクレイピング</h3>
<pre class="r"><code>session &lt;- rvest::html_session(&quot;http://www.miraitankakai.com/comments.html&quot;)

table &lt;- session %&gt;%
  rvest::html_node(&quot;body&quot;) %&gt;%
  rvest::html_node(&quot;div&quot;) %&gt;%
  rvest::html_node(&quot;table&quot;) %&gt;%
  rvest::html_table(fill = TRUE)

headings &lt;- session %&gt;%
  rvest::html_node(&quot;body&quot;) %&gt;%
  rvest::html_node(&quot;div&quot;) %&gt;%
  rvest::html_node(&quot;table&quot;) %&gt;%
  rvest::html_node(&quot;tbody&quot;) %&gt;%
  rvest::html_nodes(&quot;td &gt; b&quot;) %&gt;%
  rvest::html_text() %&gt;%
  stringr::str_remove_all(regex(&quot;([0-9]+年[0-9]+月号)&quot;)) %&gt;%
  stringr::str_remove_all(fixed(&quot;ページトップへ&quot;)) %&gt;%
  stringr::str_remove_all(&quot;[:cntrl:]&quot;) %&gt;%
  stringr::str_remove_all(&quot;[:blank:]&quot;) %&gt;%
  purrr::discard(. == &quot;&quot;)

head(headings)
#&gt; [1] &quot;『乱反射する「母」と「ラブ」』山崎聡子&quot;
#&gt; [2] &quot;『「わたし」のいるところ』山崎聡子&quot;    
#&gt; [3] &quot;『すべて失うも良し』高島裕&quot;            
#&gt; [4] &quot;『他者としての韓国』高島裕&quot;            
#&gt; [5] &quot;『富山の息吹』高島裕&quot;                  
#&gt; [6] &quot;『バカの幸ふ国』高島裕&quot;</code></pre>
</div>
<div id="整形" class="section level3">
<h3>整形</h3>
<pre class="r"><code>normalize &lt;- function(str) {
  str %&gt;%
    stringr::str_remove_all(regex(&quot;([0-9]+年[0-9]+月号)&quot;)) %&gt;%
    stringr::str_remove_all(fixed(&quot;ページトップへ&quot;)) %&gt;%
    stringr::str_remove_all(&quot;[:cntrl:]&quot;) %&gt;%
    stringr::str_remove_all(&quot;[:blank:]&quot;) %&gt;%
    return()
}

doc_headings &lt;- table %&gt;%
  tibble::rowid_to_column() %&gt;%
  dplyr::mutate(
    normalized = normalize(X1)
  ) %&gt;%
  dplyr::filter(normalized %in% headings) %&gt;%
  dplyr::pull(rowid)

df &lt;- imap_dfr(doc_headings, function(idx, i) {
  doc_heading &lt;- table %&gt;%
    tibble::rowid_to_column() %&gt;%
    dplyr::filter(rowid == idx) %&gt;%
    dplyr::pull(X1)

  head &lt;- doc_headings[i] + 1
  tail &lt;- dplyr::if_else(
    i == length(doc_headings),
    nrow(table),
    as.integer(doc_headings[i + 1] - 1)
  )

  doc_body &lt;- table %&gt;%
    tibble::rowid_to_column() %&gt;%
    dplyr::filter(rowid %in% head:tail) %&gt;%
    dplyr::mutate(
      normalized = normalize(X1)
    ) %&gt;%
    dplyr::pull(normalized) %&gt;%
    stringr::str_c(sep = &quot;&quot;, collapse = &quot;&quot;)

  return(
    tibble::tibble(
      title = doc_heading,
      text = doc_body
    )
  )
}) %&gt;%
  tidyr::separate(title, c(&quot;title&quot;, &quot;author&quot;), sep = &quot;[:blank:]+&quot;)</code></pre>
<p>{googledrive}でドライブに保存しておきます。</p>
</div>
</div>
<div id="塔" class="section level2">
<h2>塔</h2>
<div id="塔のサイトのhtml構造" class="section level3">
<h3>塔のサイトのHTML構造</h3>
<p>一覧ページはこのような構造をしています。</p>
<pre class="html"><code>
&lt;!-- ...省略... --&gt;

&lt;div id=&quot;contents_wrapper&quot; class=&quot;w900 mt40 mb80&quot;&gt;
&lt;article id=&quot;content&quot; class=&quot;main&quot;&gt;
      &lt;header class=&quot;mb50&quot;&gt;
        &lt;h1 class=&quot;page_title&quot;&gt;短歌時評&lt;/h1&gt;
      &lt;/header&gt;
      &lt;div class=&quot;content_box&quot;&gt;

            &lt;article&gt;
              &lt;section&gt;
                &lt;ul class=&quot;magazine_list magazine_archive_list cf&quot;&gt;

                  
                    
                      &lt;li class=&quot;magazine_list_li&quot;&gt;
                          &lt;p class=&quot;date&quot;&gt;2020年4月号&lt;/p&gt;
                          &lt;h2&gt;&lt;a href=&quot;http://toutankakai.com/magazine/post/11133/&quot; class=&quot;opacity&quot;&gt;運用と手順・杉原一司  /  吉田 恭大&lt;/a&gt;&lt;/h2&gt;
                      &lt;/li&gt;

&lt;!-- ...省略... --&gt;
</code></pre>
<p>それぞれの投稿は以下のような構造です。</p>
<pre class="html"><code>
&lt;!-- ...省略... --&gt;

&lt;div id=&quot;contents_wrapper&quot; class=&quot;w900 mt40 mb80&quot;&gt;
  &lt;h1 class=&quot;page_title mb60&quot;&gt;短歌時評&lt;/h1&gt;

  &lt;div class=&quot;main_wrapper w540 fl_l&quot;&gt;


    
      &lt;article id=&quot;content&quot; class=&quot;main&quot;&gt;
        &lt;header class=&quot;entry_header&quot;&gt;

          
            &lt;h1 class=&quot;title01 mb10&quot;&gt;運用と手順・杉原一司  /  吉田 恭大&lt;/h1&gt;
            &lt;p class=&quot;date mb60&quot;&gt;2020年4月号&lt;/p&gt;

          
        &lt;/header&gt;
        &lt;div class=&quot;entry_content&quot;&gt;
          &lt;!-- ...ここに本文...  --&gt;
        &lt;/div&gt;
      &lt;/article&gt;
      
&lt;!-- ...省略... --&gt;
</code></pre>
</div>
<div id="クローリング" class="section level3">
<h3>クローリング</h3>
<p>クローリングというほどはないですが、各投稿のURLのリストが必要なので、つくります。</p>
<pre class="r"><code>session &lt;- rvest::html_session(&quot;http://toutankakai.com/magazine/category/tanka_jihyo/&quot;)

links &lt;- session %&gt;%
  rvest::html_node(&quot;div#contents_wrapper&quot;) %&gt;%
  rvest::html_node(&quot;article#content&quot;) %&gt;%
  rvest::html_node(&quot;div.content_box&quot;) %&gt;%
  rvest::html_node(&quot;article &gt; section &gt; ul.magazine_list&quot;) %&gt;%
  rvest::html_nodes(&quot;li.magazine_list_li &gt; h2 &gt; a&quot;) %&gt;%
  rvest::html_attr(&quot;href&quot;)</code></pre>
</div>
<div id="スクレイピング-1" class="section level3">
<h3>スクレイピング</h3>
<p>とくにスクレイピングしづらい構造ではないので、はじめから整形されたかたちに格納します。同様に{googledrive}でドライブに保存しておきます。</p>
<pre class="r"><code>df &lt;- purrr::map_dfr(links, function(url) {
  main &lt;- session %&gt;%
    rvest::jump_to(url) %&gt;%
    rvest::html_node(&quot;div#contents_wrapper&quot;) %&gt;%
    rvest::html_node(&quot;article#content&quot;)

  heading &lt;- main %&gt;%
    rvest::html_node(&quot;header&quot;) %&gt;%
    rvest::html_node(&quot;h1&quot;) %&gt;%
    rvest::html_text()

  content &lt;- main %&gt;%
    rvest::html_node(&quot;div.entry_content&quot;) %&gt;%
    rvest::html_text()

  Sys.sleep(1)

  return(
    tibble::tibble(
      title = heading,
      text = normalize(content)
    )
  )
}) %&gt;%
  tidyr::separate(title, c(&quot;title&quot;, &quot;author&quot;), sep = fixed(&quot;  /  &quot;))</code></pre>
</div>
</div>
<div id="セッション情報" class="section level2">
<h2>セッション情報</h2>
<pre class="r"><code>devtools::session_info()
#&gt; - Session info ---------------------------------------------------------------
#&gt;  setting  value                       
#&gt;  version  R version 3.6.3 (2020-02-29)
#&gt;  os       Windows 10 x64              
#&gt;  system   x86_64, mingw32             
#&gt;  ui       RTerm                       
#&gt;  language (EN)                        
#&gt;  collate  Japanese_Japan.932          
#&gt;  ctype    Japanese_Japan.932          
#&gt;  tz       Asia/Tokyo                  
#&gt;  date     2020-06-03                  
#&gt; 
#&gt; - Packages -------------------------------------------------------------------
#&gt;  package     * version date       lib source        
#&gt;  askpass       1.1     2019-01-13 [1] CRAN (R 3.6.3)
#&gt;  assertthat    0.2.1   2019-03-21 [1] CRAN (R 3.6.3)
#&gt;  backports     1.1.7   2020-05-13 [1] CRAN (R 3.6.3)
#&gt;  blob          1.2.1   2020-01-20 [1] CRAN (R 3.6.3)
#&gt;  blogdown      0.19    2020-05-22 [1] CRAN (R 3.6.3)
#&gt;  bookdown      0.19    2020-05-15 [1] CRAN (R 3.6.3)
#&gt;  broom         0.5.6   2020-04-20 [1] CRAN (R 3.6.3)
#&gt;  callr         3.4.3   2020-03-28 [1] CRAN (R 3.6.3)
#&gt;  cellranger    1.1.0   2016-07-27 [1] CRAN (R 3.6.3)
#&gt;  cli           2.0.2   2020-02-28 [1] CRAN (R 3.6.3)
#&gt;  colorspace    1.4-1   2019-03-18 [1] CRAN (R 3.6.3)
#&gt;  crayon        1.3.4   2017-09-16 [1] CRAN (R 3.6.3)
#&gt;  curl          4.3     2019-12-02 [1] CRAN (R 3.6.3)
#&gt;  DBI           1.1.0   2019-12-15 [1] CRAN (R 3.6.3)
#&gt;  dbplyr        1.4.4   2020-05-27 [1] CRAN (R 3.6.3)
#&gt;  desc          1.2.0   2018-05-01 [1] CRAN (R 3.6.3)
#&gt;  devtools      2.3.0   2020-04-10 [1] CRAN (R 3.6.3)
#&gt;  digest        0.6.25  2020-02-23 [1] CRAN (R 3.6.3)
#&gt;  dplyr       * 0.8.5   2020-03-07 [1] CRAN (R 3.6.3)
#&gt;  ellipsis      0.3.1   2020-05-15 [1] CRAN (R 3.6.3)
#&gt;  evaluate      0.14    2019-05-28 [1] CRAN (R 3.6.3)
#&gt;  fansi         0.4.1   2020-01-08 [1] CRAN (R 3.6.3)
#&gt;  forcats     * 0.5.0   2020-03-01 [1] CRAN (R 3.6.3)
#&gt;  fs            1.4.1   2020-04-04 [1] CRAN (R 3.6.3)
#&gt;  gargle        0.5.0   2020-05-06 [1] CRAN (R 3.6.3)
#&gt;  generics      0.0.2   2018-11-29 [1] CRAN (R 3.6.3)
#&gt;  ggplot2     * 3.3.0   2020-03-05 [1] CRAN (R 3.6.3)
#&gt;  glue          1.4.1   2020-05-13 [1] CRAN (R 3.6.3)
#&gt;  googledrive   1.0.1   2020-05-05 [1] CRAN (R 3.6.3)
#&gt;  gtable        0.3.0   2019-03-25 [1] CRAN (R 3.6.3)
#&gt;  haven         2.3.0   2020-05-24 [1] CRAN (R 3.6.3)
#&gt;  hms           0.5.3   2020-01-08 [1] CRAN (R 3.6.3)
#&gt;  htmltools     0.4.0   2019-10-04 [1] CRAN (R 3.6.3)
#&gt;  httr          1.4.1   2019-08-05 [1] CRAN (R 3.6.3)
#&gt;  jsonlite      1.6.1   2020-02-02 [1] CRAN (R 3.6.3)
#&gt;  knitr         1.28    2020-02-06 [1] CRAN (R 3.6.3)
#&gt;  lattice       0.20-38 2018-11-04 [2] CRAN (R 3.6.3)
#&gt;  lifecycle     0.2.0   2020-03-06 [1] CRAN (R 3.6.3)
#&gt;  lubridate     1.7.8   2020-04-06 [1] CRAN (R 3.6.3)
#&gt;  magrittr      1.5     2014-11-22 [1] CRAN (R 3.6.3)
#&gt;  memoise       1.1.0   2017-04-21 [1] CRAN (R 3.6.3)
#&gt;  mime          0.9     2020-02-04 [1] CRAN (R 3.6.2)
#&gt;  modelr        0.1.8   2020-05-19 [1] CRAN (R 3.6.3)
#&gt;  munsell       0.5.0   2018-06-12 [1] CRAN (R 3.6.3)
#&gt;  nlme          3.1-144 2020-02-06 [2] CRAN (R 3.6.3)
#&gt;  openssl       1.4.1   2019-07-18 [1] CRAN (R 3.6.3)
#&gt;  pillar        1.4.4   2020-05-05 [1] CRAN (R 3.6.3)
#&gt;  pkgbuild      1.0.8   2020-05-07 [1] CRAN (R 3.6.3)
#&gt;  pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 3.6.3)
#&gt;  pkgload       1.0.2   2018-10-29 [1] CRAN (R 3.6.3)
#&gt;  prettyunits   1.1.1   2020-01-24 [1] CRAN (R 3.6.3)
#&gt;  processx      3.4.2   2020-02-09 [1] CRAN (R 3.6.3)
#&gt;  ps            1.3.3   2020-05-08 [1] CRAN (R 3.6.3)
#&gt;  purrr       * 0.3.4   2020-04-17 [1] CRAN (R 3.6.3)
#&gt;  R.cache       0.14.0  2019-12-06 [1] CRAN (R 3.6.3)
#&gt;  R.methodsS3   1.8.0   2020-02-14 [1] CRAN (R 3.6.2)
#&gt;  R.oo          1.23.0  2019-11-03 [1] CRAN (R 3.6.2)
#&gt;  R.utils       2.9.2   2019-12-08 [1] CRAN (R 3.6.3)
#&gt;  R6            2.4.1   2019-11-12 [1] CRAN (R 3.6.3)
#&gt;  Rcpp          1.0.4.6 2020-04-09 [1] CRAN (R 3.6.3)
#&gt;  readr       * 1.3.1   2018-12-21 [1] CRAN (R 3.6.3)
#&gt;  readxl        1.3.1   2019-03-13 [1] CRAN (R 3.6.3)
#&gt;  remotes       2.1.1   2020-02-15 [1] CRAN (R 3.6.3)
#&gt;  reprex        0.3.0   2019-05-16 [1] CRAN (R 3.6.3)
#&gt;  rlang         0.4.6   2020-05-02 [1] CRAN (R 3.6.3)
#&gt;  rmarkdown     2.1     2020-01-20 [1] CRAN (R 3.6.3)
#&gt;  rprojroot     1.3-2   2018-01-03 [1] CRAN (R 3.6.3)
#&gt;  rstudioapi    0.11    2020-02-07 [1] CRAN (R 3.6.3)
#&gt;  rvest         0.3.5   2019-11-08 [1] CRAN (R 3.6.3)
#&gt;  scales        1.1.1   2020-05-11 [1] CRAN (R 3.6.3)
#&gt;  selectr       0.4-2   2019-11-20 [1] CRAN (R 3.6.3)
#&gt;  sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 3.6.3)
#&gt;  stringi       1.4.6   2020-02-17 [1] CRAN (R 3.6.2)
#&gt;  stringr     * 1.4.0   2019-02-10 [1] CRAN (R 3.6.3)
#&gt;  styler        1.3.2   2020-02-23 [1] CRAN (R 3.6.3)
#&gt;  testthat      2.3.2   2020-03-02 [1] CRAN (R 3.6.3)
#&gt;  tibble      * 3.0.1   2020-04-20 [1] CRAN (R 3.6.3)
#&gt;  tidyr       * 1.1.0   2020-05-20 [1] CRAN (R 3.6.3)
#&gt;  tidyselect    1.1.0   2020-05-11 [1] CRAN (R 3.6.3)
#&gt;  tidyverse   * 1.3.0   2019-11-21 [1] CRAN (R 3.6.3)
#&gt;  usethis       1.6.1   2020-04-29 [1] CRAN (R 3.6.3)
#&gt;  vctrs         0.3.0   2020-05-11 [1] CRAN (R 3.6.3)
#&gt;  withr         2.2.0   2020-04-20 [1] CRAN (R 3.6.3)
#&gt;  xfun          0.14    2020-05-20 [1] CRAN (R 3.6.3)
#&gt;  xml2          1.3.2   2020-04-23 [1] CRAN (R 3.6.3)
#&gt;  yaml          2.2.1   2020-02-01 [1] CRAN (R 3.6.3)
#&gt; 
#&gt; [1] C:/Users/user/Documents/R/win-library/3.6
#&gt; [2] C:/Program Files/R/R-3.6.3/library</code></pre>
</div>
