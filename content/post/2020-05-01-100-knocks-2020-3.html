---
title: Rで言語処理100本ノックを解くわけがない（３）
author: paithiov909
date: '2020-05-01'
slug: 100-knocks-2020-3
categories: []
tags:
  - NLP
description: '...'
---



<div id="section" class="section level2">
<h2>係り受け解析</h2>
<pre class="r"><code>temp &lt;- tempfile(fileext = &quot;.txt&quot;)
download.file(&quot;https://nlp100.github.io/data/neko.txt&quot;, temp)
neko &lt;- readtext::readtext(temp, encoding = &quot;UTF-8&quot;)
neko$text[1] %&gt;%
  readr::read_lines(skip_empty_rows = TRUE) %&gt;%
  length()
#&gt; [1] 9210</code></pre>
<div id="section-1" class="section level3">
<h3>40. 係り受け解析結果の読み込み（形態素）</h3>
<p>ここでも<a href="https://paithiov909.github.io/pipian/">オレオレパッケージ</a>を使います。設問の通りにクラスを実装したりはしませんが、だいたい似たような情報を出力できます。</p>
<p>ただ、以下の処理は律儀に文の数だけCaboChaを呼んでいるため、非常に遅いです（ちゃんとやる場合、<code>pipian::cabochaFlatXML</code>に文章をまるごと渡して、戻り値のflat XMLを自分で解析したほうがよいでしょう）。ここでは、解析するのはごく一部だけにしています。</p>
<pre class="r"><code>res &lt;- neko$text[1] %&gt;%
  readr::read_lines(skip_empty_rows = TRUE)
res &lt;- stringr::str_c(res[1:20], sep = &quot; &quot;) %&gt;%
  iconv(from = &quot;UTF-8&quot;, to = &quot;CP932&quot;) %&gt;%
  purrr::imap_dfr(function(str, sid) {
    res &lt;- pipian::cabochaFlatXML(str) %&gt;%
      pipian::CabochaR()
    df &lt;- res$as.tibble()
    return(
      dplyr::bind_cols(
        data.frame(sid = rep(sid, nrow(df))),
        df
      )
    )
  })

head(res)
#&gt;   sid chunk_id D1 D2 rel     score head func tok_id word   POS1   POS2
#&gt; 1   1        3  0 -1   D  0.000000    0    0      0   一   名詞     数
#&gt; 2   2        3  0  2   D -0.764522    0    0      0   　   記号   空白
#&gt; 3   2        5  1  2   D -0.764522    1    2      1 吾輩   名詞 代名詞
#&gt; 4   2        5  1  2   D -0.764522    1    2      2   は   助詞 係助詞
#&gt; 5   2        8  2 -1   D  0.000000    3    5      3   猫   名詞   一般
#&gt; 6   2        8  2 -1   D  0.000000    3    5      4   で 助動詞      *
#&gt;   POS3 POS4 X5StageUse1 X5StageUse2 Original    Yomi1    Yomi2
#&gt; 1    *    *           *           *       一     イチ     イチ
#&gt; 2    *    *           *           *       　       　       　
#&gt; 3 一般    *           *           *     吾輩 ワガハイ ワガハイ
#&gt; 4    *    *           *           *       は       ハ       ワ
#&gt; 5    *    *           *           *       猫     ネコ     ネコ
#&gt; 6    *    *    特殊・ダ      連用形       だ       デ       デ</code></pre>
<p>3文目の形態素列</p>
<pre class="r"><code>res %&gt;%
  dplyr::filter(sid == 3) %&gt;%
  dplyr::select(word)
#&gt;   word
#&gt; 1 名前
#&gt; 2   は
#&gt; 3 まだ
#&gt; 4 無い
#&gt; 5   。</code></pre>
</div>
<div id="section-2" class="section level3">
<h3>41. 係り受け解析結果の読み込み（文節・係り受け）</h3>
<p>省きます（必要なとき都度探す感じで）。</p>
</div>
<div id="section-3" class="section level3">
<h3>42. 係り元と係り先の文節の表示</h3>
<pre class="r"><code>memo &lt;- res %&gt;%
  dplyr::filter(POS1 != &quot;記号&quot;) %&gt;%
  dplyr::group_by(sid, chunk_id) %&gt;%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = &quot;&quot;
    )
  ) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(sid, chunk_id, D1, D2, chunk) %&gt;%
  dplyr::distinct()

memo %&gt;%
  dplyr::filter(D2 != -1) %&gt;%
  dplyr::group_by(sid, chunk_id, D1) %&gt;%
  dplyr::mutate(colocation = stringr::str_c(
    chunk,
    memo$chunk[memo$sid == .data$sid &amp; memo$D1 == .data$D2],
    sep = &quot; &quot;
  )) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(chunk, colocation) %&gt;%
  head()
#&gt; # A tibble: 6 x 2
#&gt;   chunk    colocation     
#&gt;   &lt;chr&gt;    &lt;chr&gt;          
#&gt; 1 吾輩は   吾輩は 猫である
#&gt; 2 名前は   名前は 無い    
#&gt; 3 まだ     まだ 無い      
#&gt; 4 どこで   どこで 生れたか
#&gt; 5 生れたか 生れたか つかぬ
#&gt; 6 とんと   とんと つかぬ</code></pre>
</div>
<div id="section-4" class="section level3">
<h3>43. 名詞を含む文節が動詞を含む文節に係るものを抽出</h3>
<pre class="r"><code>memo &lt;- res %&gt;%
  dplyr::group_by(sid, chunk_id) %&gt;%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = &quot;&quot;
    )
  ) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::mutate(tag = POS1 == &quot;動詞&quot;) %&gt;%
  dplyr::select(sid, chunk_id, D1, D2, chunk, POS1, tag) %&gt;%
  dplyr::distinct()

memo %&gt;%
  dplyr::filter(POS1 == &quot;名詞&quot;) %&gt;%
  dplyr::filter(D2 != -1) %&gt;%
  dplyr::group_by(sid, chunk_id, D1) %&gt;%
  dplyr::mutate(colocation = stringr::str_c(
    chunk,
    memo$chunk[memo$sid == .data$sid &amp; memo$D1 == .data$D2 &amp; memo$tag == TRUE],
    sep = &quot; &quot;
  )) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(chunk, colocation) %&gt;%
  dplyr::filter(chunk != colocation) %&gt;%
  head()
#&gt; # A tibble: 6 x 2
#&gt;   chunk        colocation                 
#&gt;   &lt;chr&gt;        &lt;chr&gt;                      
#&gt; 1 　どこで     　どこで 生れたか          
#&gt; 2 見当が       見当が つかぬ。            
#&gt; 3 所で         所で 泣いて                
#&gt; 4 ニャーニャー ニャーニャー 泣いて        
#&gt; 5 いた事だけは いた事だけは 記憶している。
#&gt; 6 吾輩は       吾輩は 見た。</code></pre>
</div>
<div id="section-5" class="section level3">
<h3>44. 係り受け木の可視化</h3>
<p>そういう関数があるのでサボります。</p>
<pre class="r"><code>graph &lt;- neko$text[1] %&gt;%
  readr::read_lines(skip_empty_rows = TRUE)
tbl &lt;- graph[12] %&gt;%
  iconv(from = &quot;UTF-8&quot;, to = &quot;CP932&quot;) %&gt;%
  pipian::CabochaTbl()
tbl$plot()</code></pre>
<p><img src="/post/2020-05-01-100-knocks-2020-3_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="section-6" class="section level3">
<h3>45. 動詞の格パターンの抽出</h3>
<pre class="r"><code>memo &lt;- res %&gt;%
  dplyr::select(sid, chunk_id, D1, D2, POS1, Original) %&gt;%
  dplyr::distinct()

pattern &lt;- memo %&gt;%
  dplyr::filter(POS1 == &quot;動詞&quot;) %&gt;%
  dplyr::group_by(sid, chunk_id, D1) %&gt;%
  dplyr::mutate(colocation = stringr::str_c(
    &quot;&quot;,
    memo$Original[memo$sid == .data$sid &amp; memo$D2 == .data$D1 &amp; memo$POS1 == &quot;助詞&quot;],
    collapse = &quot; &quot;
  )) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(Original, colocation)

pattern
#&gt; # A tibble: 49 x 2
#&gt;    Original colocation
#&gt;    &lt;chr&gt;    &lt;chr&gt;     
#&gt;  1 生れる   で        
#&gt;  2 つく     か が     
#&gt;  3 する     &quot;&quot;        
#&gt;  4 泣く     で        
#&gt;  5 する     て だけ は
#&gt;  6 いる     て だけ は
#&gt;  7 始める   で        
#&gt;  8 見る     は を     
#&gt;  9 聞く     で        
#&gt; 10 捕える   を        
#&gt; # ... with 39 more rows</code></pre>
<p>「する」「見る」「与える」という動詞の格パターン</p>
<pre class="r"><code>pattern %&gt;%
  dplyr::filter(Original %in% c(&quot;する&quot;, &quot;見る&quot;, &quot;与える&quot;)) %&gt;%
  dplyr::group_by(Original, colocation) %&gt;%
  dplyr::count()
#&gt; # A tibble: 9 x 3
#&gt; # Groups:   Original, colocation [9]
#&gt;   Original colocation     n
#&gt;   &lt;chr&gt;    &lt;chr&gt;      &lt;int&gt;
#&gt; 1 する     &quot;&quot;             4
#&gt; 2 する     が             2
#&gt; 3 する     が と で       1
#&gt; 4 する     て だけ は     1
#&gt; 5 する     も             1
#&gt; 6 する     をもって       1
#&gt; 7 見る     て を          1
#&gt; 8 見る     の             1
#&gt; 9 見る     は を          1</code></pre>
</div>
<div id="section-7" class="section level3">
<h3>46. 動詞の格フレーム情報の抽出</h3>
<p>これを見ると「だけは」みたいな助詞の連続が要件通りに表示できていないことがわかりますが、もう疲れたのであきらめます。</p>
<pre class="r"><code>memo &lt;- res %&gt;%
  dplyr::group_by(sid, chunk_id) %&gt;%
  dplyr::mutate(
    chunk = stringr::str_c(
      word,
      collapse = &quot;&quot;
    )
  ) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(sid, chunk_id, D1, D2, POS1, Original, chunk) %&gt;%
  dplyr::distinct()

pattern &lt;- memo %&gt;%
  dplyr::filter(POS1 == &quot;動詞&quot;) %&gt;%
  dplyr::group_by(sid, chunk_id, D1) %&gt;%
  dplyr::mutate(colocation = stringr::str_c(
    &quot;&quot;,
    memo$Original[memo$sid == .data$sid &amp; memo$D2 == .data$D1 &amp; memo$POS1 == &quot;助詞&quot;],
    collapse = &quot; &quot;
  )) %&gt;%
  mutate(chunk = stringr::str_c(
    &quot;&quot;,
    memo$chunk[memo$sid == .data$sid &amp; memo$D2 == .data$D1 &amp; memo$POS1 == &quot;助詞&quot;],
    collapse = &quot; &quot;
  )) %&gt;%
  dplyr::ungroup() %&gt;%
  dplyr::select(Original, colocation, chunk)

pattern
#&gt; # A tibble: 49 x 3
#&gt;    Original colocation chunk                           
#&gt;    &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;                           
#&gt;  1 生れる   で         　どこで                        
#&gt;  2 つく     か が      生れたか 見当が                 
#&gt;  3 する     &quot;&quot;         &quot;&quot;                              
#&gt;  4 泣く     で         所で                            
#&gt;  5 する     て だけ は 泣いて いた事だけは いた事だけは
#&gt;  6 いる     て だけ は 泣いて いた事だけは いた事だけは
#&gt;  7 始める   で         ここで                          
#&gt;  8 見る     は を      吾輩は ものを                   
#&gt;  9 聞く     で         あとで                          
#&gt; 10 捕える   を         我々を                          
#&gt; # ... with 39 more rows</code></pre>
<p>以下略</p>
</div>
</div>
